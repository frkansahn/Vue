{"remainingRequest":"C:\\Users\\pc\\Desktop\\Restoran\\Restoran\\Restoran.UI\\client\\node_modules\\babel-loader\\lib\\index.js!C:\\Users\\pc\\Desktop\\Restoran\\Restoran\\Restoran.UI\\client\\node_modules\\@ckeditor\\ckeditor5-engine\\src\\view\\renderer.js","dependencies":[{"path":"C:\\Users\\pc\\Desktop\\Restoran\\Restoran\\Restoran.UI\\client\\node_modules\\@ckeditor\\ckeditor5-engine\\src\\view\\renderer.js","mtime":499162500000},{"path":"C:\\Users\\pc\\Desktop\\Restoran\\Restoran\\Restoran.UI\\client\\node_modules\\@ckeditor\\ckeditor5-dev-webpack-plugin\\lib\\translatesourceloader.js","mtime":499162500000},{"path":"C:\\Users\\pc\\Desktop\\Restoran\\Restoran\\Restoran.UI\\client\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1581760768702},{"path":"C:\\Users\\pc\\Desktop\\Restoran\\Restoran\\Restoran.UI\\client\\node_modules\\babel-loader\\lib\\index.js","mtime":1581760768279}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3ltYm9sIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3ltYm9sLmRlc2NyaXB0aW9uIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3ltYm9sLml0ZXJhdG9yIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuY29uY2F0IjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZnJvbSI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmluZGV4LW9mIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuam9pbiI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5Lm1hcCI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNwbGljZSI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmZ1bmN0aW9uLm5hbWUiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QudG8tc3RyaW5nIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc2V0IjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLml0ZXJhdG9yIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLmFuY2hvciI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuaXRlcmF0b3IiOwppbXBvcnQgX2NsYXNzQ2FsbENoZWNrIGZyb20gIkM6XFxVc2Vyc1xccGNcXERlc2t0b3BcXFJlc3RvcmFuXFxSZXN0b3JhblxcUmVzdG9yYW4uVUlcXGNsaWVudFxcbm9kZV9tb2R1bGVzXFxAYmFiZWxcXHJ1bnRpbWUvaGVscGVycy9lc20vY2xhc3NDYWxsQ2hlY2siOwppbXBvcnQgX2NyZWF0ZUNsYXNzIGZyb20gIkM6XFxVc2Vyc1xccGNcXERlc2t0b3BcXFJlc3RvcmFuXFxSZXN0b3JhblxcUmVzdG9yYW4uVUlcXGNsaWVudFxcbm9kZV9tb2R1bGVzXFxAYmFiZWxcXHJ1bnRpbWUvaGVscGVycy9lc20vY3JlYXRlQ2xhc3MiOwoKLyoqCiAqIEBsaWNlbnNlIENvcHlyaWdodCAoYykgMjAwMy0yMDIwLCBDS1NvdXJjZSAtIEZyZWRlcmljbyBLbmFiYmVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBGb3IgbGljZW5zaW5nLCBzZWUgTElDRU5TRS5tZCBvciBodHRwczovL2NrZWRpdG9yLmNvbS9sZWdhbC9ja2VkaXRvci1vc3MtbGljZW5zZQogKi8KCi8qIGdsb2JhbHMgTm9kZSAqLwoKLyoqCiAqIEBtb2R1bGUgZW5naW5lL3ZpZXcvcmVuZGVyZXIKICovCmltcG9ydCBWaWV3VGV4dCBmcm9tICcuL3RleHQnOwppbXBvcnQgVmlld1Bvc2l0aW9uIGZyb20gJy4vcG9zaXRpb24nOwppbXBvcnQgeyBJTkxJTkVfRklMTEVSLCBJTkxJTkVfRklMTEVSX0xFTkdUSCwgc3RhcnRzV2l0aEZpbGxlciwgaXNJbmxpbmVGaWxsZXIgfSBmcm9tICcuL2ZpbGxlcic7CmltcG9ydCBtaXggZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMvbWl4JzsKaW1wb3J0IGRpZmYgZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMvZGlmZic7CmltcG9ydCBpbnNlcnRBdCBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy9kb20vaW5zZXJ0YXQnOwppbXBvcnQgcmVtb3ZlIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2RvbS9yZW1vdmUnOwppbXBvcnQgT2JzZXJ2YWJsZU1peGluIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL29ic2VydmFibGVtaXhpbic7CmltcG9ydCBDS0VkaXRvckVycm9yIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2NrZWRpdG9yZXJyb3InOwppbXBvcnQgaXNUZXh0IGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2RvbS9pc3RleHQnOwppbXBvcnQgaXNOb2RlIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2RvbS9pc25vZGUnOwppbXBvcnQgZmFzdERpZmYgZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMvZmFzdGRpZmYnOwppbXBvcnQgZW52IGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2Vudic7Ci8qKgogKiBSZW5kZXJlciBpcyByZXNwb25zaWJsZSBmb3IgdXBkYXRpbmcgdGhlIERPTSBzdHJ1Y3R1cmUgYW5kIHRoZSBET00gc2VsZWN0aW9uIGJhc2VkIG9uCiAqIHRoZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS92aWV3L3JlbmRlcmVyflJlbmRlcmVyI21hcmtUb1N5bmMgaW5mb3JtYXRpb24gYWJvdXQgdXBkYXRlZCB2aWV3IG5vZGVzfS4KICogSW4gb3RoZXIgd29yZHMsIGl0IHJlbmRlcnMgdGhlIHZpZXcgdG8gdGhlIERPTS4KICoKICogSXRzIG1haW4gcmVzcG9uc2liaWxpdHkgaXMgdG8gbWFrZSBvbmx5IHRoZSBuZWNlc3NhcnksIG1pbmltYWwgY2hhbmdlcyB0byB0aGUgRE9NLiBIb3dldmVyLCB1bmxpa2UgaW4gbWFueQogKiB2aXJ0dWFsIERPTSBpbXBsZW1lbnRhdGlvbnMsIHRoZSBwcmltYXJ5IHJlYXNvbiBmb3IgZG9pbmcgbWluaW1hbCBjaGFuZ2VzIGlzIG5vdCB0aGUgcGVyZm9ybWFuY2UgYnV0IGVuc3VyaW5nCiAqIHRoYXQgbmF0aXZlIGVkaXRpbmcgZmVhdHVyZXMgc3VjaCBhcyB0ZXh0IGNvbXBvc2l0aW9uLCBhdXRvY29tcGxldGlvbiwgc3BlbGwgY2hlY2tpbmcsIHNlbGVjdGlvbidzIHgtaW5kZXggYXJlCiAqIGFmZmVjdGVkIGFzIGxpdHRsZSBhcyBwb3NzaWJsZS4KICoKICogUmVuZGVyZXIgdXNlcyB7QGxpbmsgbW9kdWxlOmVuZ2luZS92aWV3L2RvbWNvbnZlcnRlcn5Eb21Db252ZXJ0ZXJ9IHRvIHRyYW5zZm9ybSB2aWV3IG5vZGVzIGFuZCBwb3NpdGlvbnMKICogdG8gYW5kIGZyb20gdGhlIERPTS4KICovCgp2YXIgUmVuZGVyZXIgPQovKiNfX1BVUkVfXyovCmZ1bmN0aW9uICgpIHsKICAvKioKICAgKiBDcmVhdGVzIGEgcmVuZGVyZXIgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9kb21jb252ZXJ0ZXJ+RG9tQ29udmVydGVyfSBkb21Db252ZXJ0ZXIgQ29udmVydGVyIGluc3RhbmNlLgogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS92aWV3L2RvY3VtZW50c2VsZWN0aW9ufkRvY3VtZW50U2VsZWN0aW9ufSBzZWxlY3Rpb24gVmlldyBzZWxlY3Rpb24uCiAgICovCiAgZnVuY3Rpb24gUmVuZGVyZXIoZG9tQ29udmVydGVyLCBzZWxlY3Rpb24pIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBSZW5kZXJlcik7CgogICAgLyoqCiAgICAgKiBTZXQgb2YgRE9NIERvY3VtZW50cyBpbnN0YW5jZXMuCiAgICAgKgogICAgICogQHJlYWRvbmx5CiAgICAgKiBAbWVtYmVyIHtTZXQuPERvY3VtZW50Pn0KICAgICAqLwogICAgdGhpcy5kb21Eb2N1bWVudHMgPSBuZXcgU2V0KCk7CiAgICAvKioKICAgICAqIENvbnZlcnRlciBpbnN0YW5jZS4KICAgICAqCiAgICAgKiBAcmVhZG9ubHkKICAgICAqIEBtZW1iZXIge21vZHVsZTplbmdpbmUvdmlldy9kb21jb252ZXJ0ZXJ+RG9tQ29udmVydGVyfQogICAgICovCgogICAgdGhpcy5kb21Db252ZXJ0ZXIgPSBkb21Db252ZXJ0ZXI7CiAgICAvKioKICAgICAqIFNldCBvZiBub2RlcyB3aGljaCBhdHRyaWJ1dGVzIGNoYW5nZWQgYW5kIG1heSBuZWVkIHRvIGJlIHJlbmRlcmVkLgogICAgICoKICAgICAqIEByZWFkb25seQogICAgICogQG1lbWJlciB7U2V0Ljxtb2R1bGU6ZW5naW5lL3ZpZXcvbm9kZX5Ob2RlPn0KICAgICAqLwoKICAgIHRoaXMubWFya2VkQXR0cmlidXRlcyA9IG5ldyBTZXQoKTsKICAgIC8qKgogICAgICogU2V0IG9mIGVsZW1lbnRzIHdoaWNoIGNoaWxkIGxpc3RzIGNoYW5nZWQgYW5kIG1heSBuZWVkIHRvIGJlIHJlbmRlcmVkLgogICAgICoKICAgICAqIEByZWFkb25seQogICAgICogQG1lbWJlciB7U2V0Ljxtb2R1bGU6ZW5naW5lL3ZpZXcvbm9kZX5Ob2RlPn0KICAgICAqLwoKICAgIHRoaXMubWFya2VkQ2hpbGRyZW4gPSBuZXcgU2V0KCk7CiAgICAvKioKICAgICAqIFNldCBvZiB0ZXh0IG5vZGVzIHdoaWNoIHRleHQgZGF0YSBjaGFuZ2VkIGFuZCBtYXkgbmVlZCB0byBiZSByZW5kZXJlZC4KICAgICAqCiAgICAgKiBAcmVhZG9ubHkKICAgICAqIEBtZW1iZXIge1NldC48bW9kdWxlOmVuZ2luZS92aWV3L25vZGV+Tm9kZT59CiAgICAgKi8KCiAgICB0aGlzLm1hcmtlZFRleHRzID0gbmV3IFNldCgpOwogICAgLyoqCiAgICAgKiBWaWV3IHNlbGVjdGlvbi4gUmVuZGVyZXIgdXBkYXRlcyBET00gc2VsZWN0aW9uIGJhc2VkIG9uIHRoZSB2aWV3IHNlbGVjdGlvbi4KICAgICAqCiAgICAgKiBAcmVhZG9ubHkKICAgICAqIEBtZW1iZXIge21vZHVsZTplbmdpbmUvdmlldy9kb2N1bWVudHNlbGVjdGlvbn5Eb2N1bWVudFNlbGVjdGlvbn0KICAgICAqLwoKICAgIHRoaXMuc2VsZWN0aW9uID0gc2VsZWN0aW9uOwogICAgLyoqCiAgICAgKiBJbmRpY2F0ZXMgaWYgdGhlIHZpZXcgZG9jdW1lbnQgaXMgZm9jdXNlZCBhbmQgc2VsZWN0aW9uIGNhbiBiZSByZW5kZXJlZC4gU2VsZWN0aW9uIHdpbGwgbm90IGJlIHJlbmRlcmVkIGlmCiAgICAgKiB0aGlzIGlzIHNldCB0byBgZmFsc2VgLgogICAgICoKICAgICAqIEBtZW1iZXIge0Jvb2xlYW59CiAgICAgKi8KCiAgICB0aGlzLmlzRm9jdXNlZCA9IGZhbHNlOwogICAgLyoqCiAgICAgKiBUaGUgdGV4dCBub2RlIGluIHdoaWNoIHRoZSBpbmxpbmUgZmlsbGVyIHdhcyByZW5kZXJlZC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQG1lbWJlciB7VGV4dH0KICAgICAqLwoKICAgIHRoaXMuX2lubGluZUZpbGxlciA9IG51bGw7CiAgICAvKioKICAgICAqIERPTSBlbGVtZW50IGNvbnRhaW5pbmcgZmFrZSBzZWxlY3Rpb24uCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEB0eXBlIHtudWxsfEhUTUxFbGVtZW50fQogICAgICovCgogICAgdGhpcy5fZmFrZVNlbGVjdGlvbkNvbnRhaW5lciA9IG51bGw7CiAgfQogIC8qKgogICAqIE1hcmtzIGEgdmlldyBub2RlIHRvIGJlIHVwZGF0ZWQgaW4gdGhlIERPTSBieSB7QGxpbmsgI3JlbmRlciBgcmVuZGVyKClgfS4KICAgKgogICAqIE5vdGUgdGhhdCBvbmx5IHZpZXcgbm9kZXMgd2hvc2UgcGFyZW50cyBoYXZlIGNvcnJlc3BvbmRpbmcgRE9NIGVsZW1lbnRzIG5lZWQgdG8gYmUgbWFya2VkIHRvIGJlIHN5bmNocm9uaXplZC4KICAgKgogICAqIEBzZWUgI21hcmtlZEF0dHJpYnV0ZXMKICAgKiBAc2VlICNtYXJrZWRDaGlsZHJlbgogICAqIEBzZWUgI21hcmtlZFRleHRzCiAgICoKICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9kb2N1bWVudH5DaGFuZ2VUeXBlfSB0eXBlIFR5cGUgb2YgdGhlIGNoYW5nZS4KICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9ub2Rlfk5vZGV9IG5vZGUgTm9kZSB0byBiZSBtYXJrZWQuCiAgICovCgoKICBfY3JlYXRlQ2xhc3MoUmVuZGVyZXIsIFt7CiAgICBrZXk6ICJtYXJrVG9TeW5jIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBtYXJrVG9TeW5jKHR5cGUsIG5vZGUpIHsKICAgICAgaWYgKHR5cGUgPT09ICd0ZXh0JykgewogICAgICAgIGlmICh0aGlzLmRvbUNvbnZlcnRlci5tYXBWaWV3VG9Eb20obm9kZS5wYXJlbnQpKSB7CiAgICAgICAgICB0aGlzLm1hcmtlZFRleHRzLmFkZChub2RlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgdGhlIG5vZGUgaGFzIG5vIERPTSBlbGVtZW50IGl0IGlzIG5vdCByZW5kZXJlZCB5ZXQsCiAgICAgICAgLy8gaXRzIGNoaWxkcmVuL2F0dHJpYnV0ZXMgZG8gbm90IG5lZWQgdG8gYmUgbWFya2VkIHRvIGJlIHN5bmMuCiAgICAgICAgaWYgKCF0aGlzLmRvbUNvbnZlcnRlci5tYXBWaWV3VG9Eb20obm9kZSkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlID09PSAnYXR0cmlidXRlcycpIHsKICAgICAgICAgIHRoaXMubWFya2VkQXR0cmlidXRlcy5hZGQobm9kZSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnY2hpbGRyZW4nKSB7CiAgICAgICAgICB0aGlzLm1hcmtlZENoaWxkcmVuLmFkZChub2RlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBVbmtub3duIHR5cGUgcGFzc2VkIHRvIFJlbmRlcmVyLm1hcmtUb1N5bmMuCiAgICAgICAgICAgKgogICAgICAgICAgICogQGVycm9yIHJlbmRlcmVyLXVua25vd24tdHlwZQogICAgICAgICAgICovCiAgICAgICAgICB0aHJvdyBuZXcgQ0tFZGl0b3JFcnJvcigndmlldy1yZW5kZXJlci11bmtub3duLXR5cGU6IFVua25vd24gdHlwZSBwYXNzZWQgdG8gUmVuZGVyZXIubWFya1RvU3luYy4nLCB0aGlzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogUmVuZGVycyBhbGwgYnVmZmVyZWQgY2hhbmdlcyAoe0BsaW5rICNtYXJrZWRBdHRyaWJ1dGVzfSwge0BsaW5rICNtYXJrZWRDaGlsZHJlbn0gYW5kIHtAbGluayAjbWFya2VkVGV4dHN9KSBhbmQKICAgICAqIHRoZSBjdXJyZW50IHZpZXcgc2VsZWN0aW9uIChpZiBuZWVkZWQpIHRvIHRoZSBET00gYnkgYXBwbHlpbmcgYSBtaW5pbWFsIHNldCBvZiBjaGFuZ2VzIHRvIGl0LgogICAgICoKICAgICAqIFJlbmRlcmVyIHRyaWVzIG5vdCB0byBicmVhayB0aGUgdGV4dCBjb21wb3NpdGlvbiAoZS5nLiBJTUUpIGFuZCB4LWluZGV4IG9mIHRoZSBzZWxlY3Rpb24sCiAgICAgKiBzbyBpdCBkb2VzIGFzIGxpdHRsZSBhcyBpdCBpcyBuZWVkZWQgdG8gdXBkYXRlIHRoZSBET00uCiAgICAgKgogICAgICogUmVuZGVyZXIgYWxzbyBoYW5kbGVzIHtAbGluayBtb2R1bGU6ZW5naW5lL3ZpZXcvZmlsbGVyIGZpbGxlcnN9LiBFc3BlY2lhbGx5LCBpdCBjaGVja3MgaWYgdGhlIGlubGluZSBmaWxsZXIgaXMgbmVlZGVkCiAgICAgKiBhdCB0aGUgc2VsZWN0aW9uIHBvc2l0aW9uIGFuZCBhZGRzIG9yIHJlbW92ZXMgaXQuIFRvIHByZXZlbnQgYnJlYWtpbmcgdGV4dCBjb21wb3NpdGlvbiBpbmxpbmUgZmlsbGVyIHdpbGwgbm90IGJlCiAgICAgKiByZW1vdmVkIGFzIGxvbmcgYXMgdGhlIHNlbGVjdGlvbiBpcyBpbiB0aGUgdGV4dCBub2RlIHdoaWNoIG5lZWRlZCBpdCBhdCBmaXJzdC4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJyZW5kZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgdmFyIGlubGluZUZpbGxlclBvc2l0aW9uOyAvLyBSZWZyZXNoIG1hcHBpbmdzLgoKICAgICAgdmFyIF9pdGVyYXRvck5vcm1hbENvbXBsZXRpb24gPSB0cnVlOwogICAgICB2YXIgX2RpZEl0ZXJhdG9yRXJyb3IgPSBmYWxzZTsKICAgICAgdmFyIF9pdGVyYXRvckVycm9yID0gdW5kZWZpbmVkOwoKICAgICAgdHJ5IHsKICAgICAgICBmb3IgKHZhciBfaXRlcmF0b3IgPSB0aGlzLm1hcmtlZENoaWxkcmVuW1N5bWJvbC5pdGVyYXRvcl0oKSwgX3N0ZXA7ICEoX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbiA9IChfc3RlcCA9IF9pdGVyYXRvci5uZXh0KCkpLmRvbmUpOyBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uID0gdHJ1ZSkgewogICAgICAgICAgdmFyIGVsZW1lbnQgPSBfc3RlcC52YWx1ZTsKCiAgICAgICAgICB0aGlzLl91cGRhdGVDaGlsZHJlbk1hcHBpbmdzKGVsZW1lbnQpOwogICAgICAgIH0gLy8gVGhlcmUgd2FzIGlubGluZSBmaWxsZXIgcmVuZGVyZWQgaW4gdGhlIERPTSBidXQgaXQncyBub3QKICAgICAgICAvLyBhdCB0aGUgc2VsZWN0aW9uIHBvc2l0aW9uIGFueSBtb3JlLCBzbyB3ZSBjYW4gcmVtb3ZlIGl0CiAgICAgICAgLy8gKGNhdXNlIGV2ZW4gaWYgaXQncyBuZWVkZWQsIGl0IG11c3QgYmUgcGxhY2VkIGluIGFub3RoZXIgbG9jYXRpb24pLgoKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2RpZEl0ZXJhdG9yRXJyb3IgPSB0cnVlOwogICAgICAgIF9pdGVyYXRvckVycm9yID0gZXJyOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoIV9pdGVyYXRvck5vcm1hbENvbXBsZXRpb24gJiYgX2l0ZXJhdG9yLnJldHVybiAhPSBudWxsKSB7CiAgICAgICAgICAgIF9pdGVyYXRvci5yZXR1cm4oKTsKICAgICAgICAgIH0KICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKF9kaWRJdGVyYXRvckVycm9yKSB7CiAgICAgICAgICAgIHRocm93IF9pdGVyYXRvckVycm9yOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMuX2lubGluZUZpbGxlciAmJiAhdGhpcy5faXNTZWxlY3Rpb25JbklubGluZUZpbGxlcigpKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlSW5saW5lRmlsbGVyKCk7CiAgICAgIH0gLy8gSWYgd2UndmUgZ290IHRoZSBmaWxsZXIsIGxldCdzIHRyeSB0byBndWVzcyBpdHMgcG9zaXRpb24gaW4gdGhlIHZpZXcuCgoKICAgICAgaWYgKHRoaXMuX2lubGluZUZpbGxlcikgewogICAgICAgIGlubGluZUZpbGxlclBvc2l0aW9uID0gdGhpcy5fZ2V0SW5saW5lRmlsbGVyUG9zaXRpb24oKTsKICAgICAgfSAvLyBPdGhlcndpc2UsIGlmIGl0J3MgbmVlZGVkLCBjcmVhdGUgaXQgYXQgdGhlIHNlbGVjdGlvbiBwb3NpdGlvbi4KICAgICAgZWxzZSBpZiAodGhpcy5fbmVlZHNJbmxpbmVGaWxsZXJBdFNlbGVjdGlvbigpKSB7CiAgICAgICAgICBpbmxpbmVGaWxsZXJQb3NpdGlvbiA9IHRoaXMuc2VsZWN0aW9uLmdldEZpcnN0UG9zaXRpb24oKTsgLy8gRG8gbm90IHVzZSBgbWFya1RvU3luY2Agc28gaXQgd2lsbCBiZSBhZGRlZCBldmVuIGlmIHRoZSBwYXJlbnQgaXMgYWxyZWFkeSBhZGRlZC4KCiAgICAgICAgICB0aGlzLm1hcmtlZENoaWxkcmVuLmFkZChpbmxpbmVGaWxsZXJQb3NpdGlvbi5wYXJlbnQpOwogICAgICAgIH0KCiAgICAgIHZhciBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uMiA9IHRydWU7CiAgICAgIHZhciBfZGlkSXRlcmF0b3JFcnJvcjIgPSBmYWxzZTsKICAgICAgdmFyIF9pdGVyYXRvckVycm9yMiA9IHVuZGVmaW5lZDsKCiAgICAgIHRyeSB7CiAgICAgICAgZm9yICh2YXIgX2l0ZXJhdG9yMiA9IHRoaXMubWFya2VkQXR0cmlidXRlc1tTeW1ib2wuaXRlcmF0b3JdKCksIF9zdGVwMjsgIShfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uMiA9IChfc3RlcDIgPSBfaXRlcmF0b3IyLm5leHQoKSkuZG9uZSk7IF9pdGVyYXRvck5vcm1hbENvbXBsZXRpb24yID0gdHJ1ZSkgewogICAgICAgICAgdmFyIF9lbGVtZW50ID0gX3N0ZXAyLnZhbHVlOwoKICAgICAgICAgIHRoaXMuX3VwZGF0ZUF0dHJzKF9lbGVtZW50KTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIF9kaWRJdGVyYXRvckVycm9yMiA9IHRydWU7CiAgICAgICAgX2l0ZXJhdG9yRXJyb3IyID0gZXJyOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoIV9pdGVyYXRvck5vcm1hbENvbXBsZXRpb24yICYmIF9pdGVyYXRvcjIucmV0dXJuICE9IG51bGwpIHsKICAgICAgICAgICAgX2l0ZXJhdG9yMi5yZXR1cm4oKTsKICAgICAgICAgIH0KICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKF9kaWRJdGVyYXRvckVycm9yMikgewogICAgICAgICAgICB0aHJvdyBfaXRlcmF0b3JFcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjMgPSB0cnVlOwogICAgICB2YXIgX2RpZEl0ZXJhdG9yRXJyb3IzID0gZmFsc2U7CiAgICAgIHZhciBfaXRlcmF0b3JFcnJvcjMgPSB1bmRlZmluZWQ7CgogICAgICB0cnkgewogICAgICAgIGZvciAodmFyIF9pdGVyYXRvcjMgPSB0aGlzLm1hcmtlZENoaWxkcmVuW1N5bWJvbC5pdGVyYXRvcl0oKSwgX3N0ZXAzOyAhKF9pdGVyYXRvck5vcm1hbENvbXBsZXRpb24zID0gKF9zdGVwMyA9IF9pdGVyYXRvcjMubmV4dCgpKS5kb25lKTsgX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjMgPSB0cnVlKSB7CiAgICAgICAgICB2YXIgX2VsZW1lbnQyID0gX3N0ZXAzLnZhbHVlOwoKICAgICAgICAgIHRoaXMuX3VwZGF0ZUNoaWxkcmVuKF9lbGVtZW50MiwgewogICAgICAgICAgICBpbmxpbmVGaWxsZXJQb3NpdGlvbjogaW5saW5lRmlsbGVyUG9zaXRpb24KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2RpZEl0ZXJhdG9yRXJyb3IzID0gdHJ1ZTsKICAgICAgICBfaXRlcmF0b3JFcnJvcjMgPSBlcnI7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmICghX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjMgJiYgX2l0ZXJhdG9yMy5yZXR1cm4gIT0gbnVsbCkgewogICAgICAgICAgICBfaXRlcmF0b3IzLnJldHVybigpOwogICAgICAgICAgfQogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAoX2RpZEl0ZXJhdG9yRXJyb3IzKSB7CiAgICAgICAgICAgIHRocm93IF9pdGVyYXRvckVycm9yMzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uNCA9IHRydWU7CiAgICAgIHZhciBfZGlkSXRlcmF0b3JFcnJvcjQgPSBmYWxzZTsKICAgICAgdmFyIF9pdGVyYXRvckVycm9yNCA9IHVuZGVmaW5lZDsKCiAgICAgIHRyeSB7CiAgICAgICAgZm9yICh2YXIgX2l0ZXJhdG9yNCA9IHRoaXMubWFya2VkVGV4dHNbU3ltYm9sLml0ZXJhdG9yXSgpLCBfc3RlcDQ7ICEoX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjQgPSAoX3N0ZXA0ID0gX2l0ZXJhdG9yNC5uZXh0KCkpLmRvbmUpOyBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uNCA9IHRydWUpIHsKICAgICAgICAgIHZhciBub2RlID0gX3N0ZXA0LnZhbHVlOwoKICAgICAgICAgIGlmICghdGhpcy5tYXJrZWRDaGlsZHJlbi5oYXMobm9kZS5wYXJlbnQpICYmIHRoaXMuZG9tQ29udmVydGVyLm1hcFZpZXdUb0RvbShub2RlLnBhcmVudCkpIHsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlVGV4dChub2RlLCB7CiAgICAgICAgICAgICAgaW5saW5lRmlsbGVyUG9zaXRpb246IGlubGluZUZpbGxlclBvc2l0aW9uCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0gLy8gQ2hlY2sgd2hldGhlciB0aGUgaW5saW5lIGZpbGxlciBpcyByZXF1aXJlZCBhbmQgd2hlcmUgaXQgcmVhbGx5IGlzIGluIHRoZSBET00uCiAgICAgICAgLy8gQXQgdGhpcyBwb2ludCBpbiBtb3N0IGNhc2VzIGl0IHdpbGwgYmUgaW4gdGhlIERPTSwgYnV0IHRoZXJlIGFyZSBleGNlcHRpb25zLgogICAgICAgIC8vIEZvciBleGFtcGxlLCBpZiB0aGUgaW5saW5lIGZpbGxlciB3YXMgZGVlcCBpbiB0aGUgY3JlYXRlZCBET00gc3RydWN0dXJlLCBpdCB3aWxsIG5vdCBiZSBjcmVhdGVkLgogICAgICAgIC8vIFNpbWlsYXJseSwgaWYgaXQgd2FzIHJlbW92ZWQgYXQgdGhlIGJlZ2lubmluZyBvZiB0aGlzIGZ1bmN0aW9uIGFuZCB0aGVuIG5laXRoZXIgdGV4dCBub3IgY2hpbGRyZW4gd2VyZSB1cGRhdGVkLAogICAgICAgIC8vIGl0IHdpbGwgbm90IGJlIHByZXNlbnQuCiAgICAgICAgLy8gRml4IHRob3NlIGFuZCBzaW1pbGFyIHNjZW5hcmlvcy4KCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIF9kaWRJdGVyYXRvckVycm9yNCA9IHRydWU7CiAgICAgICAgX2l0ZXJhdG9yRXJyb3I0ID0gZXJyOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoIV9pdGVyYXRvck5vcm1hbENvbXBsZXRpb240ICYmIF9pdGVyYXRvcjQucmV0dXJuICE9IG51bGwpIHsKICAgICAgICAgICAgX2l0ZXJhdG9yNC5yZXR1cm4oKTsKICAgICAgICAgIH0KICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKF9kaWRJdGVyYXRvckVycm9yNCkgewogICAgICAgICAgICB0aHJvdyBfaXRlcmF0b3JFcnJvcjQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaW5saW5lRmlsbGVyUG9zaXRpb24pIHsKICAgICAgICB2YXIgZmlsbGVyRG9tUG9zaXRpb24gPSB0aGlzLmRvbUNvbnZlcnRlci52aWV3UG9zaXRpb25Ub0RvbShpbmxpbmVGaWxsZXJQb3NpdGlvbik7CiAgICAgICAgdmFyIGRvbURvY3VtZW50ID0gZmlsbGVyRG9tUG9zaXRpb24ucGFyZW50Lm93bmVyRG9jdW1lbnQ7CgogICAgICAgIGlmICghc3RhcnRzV2l0aEZpbGxlcihmaWxsZXJEb21Qb3NpdGlvbi5wYXJlbnQpKSB7CiAgICAgICAgICAvLyBGaWxsZXIgaGFzIG5vdCBiZWVuIGNyZWF0ZWQgYXQgZmlsbGVyIHBvc2l0aW9uLiBDcmVhdGUgaXQgbm93LgogICAgICAgICAgdGhpcy5faW5saW5lRmlsbGVyID0gYWRkSW5saW5lRmlsbGVyKGRvbURvY3VtZW50LCBmaWxsZXJEb21Qb3NpdGlvbi5wYXJlbnQsIGZpbGxlckRvbVBvc2l0aW9uLm9mZnNldCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEZpbGxlciBoYXMgYmVlbiBmb3VuZCwgc2F2ZSBpdC4KICAgICAgICAgIHRoaXMuX2lubGluZUZpbGxlciA9IGZpbGxlckRvbVBvc2l0aW9uLnBhcmVudDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gVGhlcmUgaXMgbm8gZmlsbGVyIG5lZWRlZC4KICAgICAgICB0aGlzLl9pbmxpbmVGaWxsZXIgPSBudWxsOwogICAgICB9CgogICAgICB0aGlzLl91cGRhdGVTZWxlY3Rpb24oKTsKCiAgICAgIHRoaXMuX3VwZGF0ZUZvY3VzKCk7CgogICAgICB0aGlzLm1hcmtlZFRleHRzLmNsZWFyKCk7CiAgICAgIHRoaXMubWFya2VkQXR0cmlidXRlcy5jbGVhcigpOwogICAgICB0aGlzLm1hcmtlZENoaWxkcmVuLmNsZWFyKCk7CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZXMgbWFwcGluZ3Mgb2YgdmlldyBlbGVtZW50J3MgY2hpbGRyZW4uCiAgICAgKgogICAgICogQ2hpbGRyZW4gdGhhdCB3ZXJlIHJlcGxhY2VkIGluIHRoZSB2aWV3IHN0cnVjdHVyZSBieSBzaW1pbGFyIGVsZW1lbnRzIChzYW1lIHRhZyBuYW1lKSBhcmUgdHJlYXRlZCBhcyAncmVwbGFjZWQnLgogICAgICogVGhpcyBtZWFucyB0aGF0IHRoZWlyIG1hcHBpbmdzIGNhbiBiZSB1cGRhdGVkIHNvIHRoZSBuZXcgdmlldyBlbGVtZW50cyBhcmUgbWFwcGVkIHRvIHRoZSBleGlzdGluZyBET00gZWxlbWVudHMuCiAgICAgKiBUaGFua3MgdG8gdGhhdCB0aGVzZSBlbGVtZW50cyBkbyBub3QgbmVlZCB0byBiZSByZS1yZW5kZXJlZCBjb21wbGV0ZWx5LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9ub2Rlfk5vZGV9IHZpZXdFbGVtZW50IFRoZSB2aWV3IGVsZW1lbnQgd2hvc2UgY2hpbGRyZW4gbWFwcGluZ3Mgd2lsbCBiZSB1cGRhdGVkLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl91cGRhdGVDaGlsZHJlbk1hcHBpbmdzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlQ2hpbGRyZW5NYXBwaW5ncyh2aWV3RWxlbWVudCkgewogICAgICB2YXIgZG9tRWxlbWVudCA9IHRoaXMuZG9tQ29udmVydGVyLm1hcFZpZXdUb0RvbSh2aWV3RWxlbWVudCk7CgogICAgICBpZiAoIWRvbUVsZW1lbnQpIHsKICAgICAgICAvLyBJZiB0aGVyZSBpcyBubyBgZG9tRWxlbWVudGAgaXQgbWVhbnMgdGhhdCBpdCB3YXMgYWxyZWFkeSByZW1vdmVkIGZyb20gRE9NIGFuZCB0aGVyZSBpcyBubyBuZWVkIHRvIHByb2Nlc3MgaXQuCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgYWN0dWFsRG9tQ2hpbGRyZW4gPSB0aGlzLmRvbUNvbnZlcnRlci5tYXBWaWV3VG9Eb20odmlld0VsZW1lbnQpLmNoaWxkTm9kZXM7CiAgICAgIHZhciBleHBlY3RlZERvbUNoaWxkcmVuID0gQXJyYXkuZnJvbSh0aGlzLmRvbUNvbnZlcnRlci52aWV3Q2hpbGRyZW5Ub0RvbSh2aWV3RWxlbWVudCwgZG9tRWxlbWVudC5vd25lckRvY3VtZW50LCB7CiAgICAgICAgd2l0aENoaWxkcmVuOiBmYWxzZQogICAgICB9KSk7CgogICAgICB2YXIgZGlmZiA9IHRoaXMuX2RpZmZOb2RlTGlzdHMoYWN0dWFsRG9tQ2hpbGRyZW4sIGV4cGVjdGVkRG9tQ2hpbGRyZW4pOwoKICAgICAgdmFyIGFjdGlvbnMgPSB0aGlzLl9maW5kUmVwbGFjZUFjdGlvbnMoZGlmZiwgYWN0dWFsRG9tQ2hpbGRyZW4sIGV4cGVjdGVkRG9tQ2hpbGRyZW4pOwoKICAgICAgaWYgKGFjdGlvbnMuaW5kZXhPZigncmVwbGFjZScpICE9PSAtMSkgewogICAgICAgIHZhciBjb3VudGVyID0gewogICAgICAgICAgZXF1YWw6IDAsCiAgICAgICAgICBpbnNlcnQ6IDAsCiAgICAgICAgICBkZWxldGU6IDAKICAgICAgICB9OwogICAgICAgIHZhciBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uNSA9IHRydWU7CiAgICAgICAgdmFyIF9kaWRJdGVyYXRvckVycm9yNSA9IGZhbHNlOwogICAgICAgIHZhciBfaXRlcmF0b3JFcnJvcjUgPSB1bmRlZmluZWQ7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBmb3IgKHZhciBfaXRlcmF0b3I1ID0gYWN0aW9uc1tTeW1ib2wuaXRlcmF0b3JdKCksIF9zdGVwNTsgIShfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uNSA9IChfc3RlcDUgPSBfaXRlcmF0b3I1Lm5leHQoKSkuZG9uZSk7IF9pdGVyYXRvck5vcm1hbENvbXBsZXRpb241ID0gdHJ1ZSkgewogICAgICAgICAgICB2YXIgYWN0aW9uID0gX3N0ZXA1LnZhbHVlOwoKICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ3JlcGxhY2UnKSB7CiAgICAgICAgICAgICAgdmFyIGluc2VydEluZGV4ID0gY291bnRlci5lcXVhbCArIGNvdW50ZXIuaW5zZXJ0OwogICAgICAgICAgICAgIHZhciBkZWxldGVJbmRleCA9IGNvdW50ZXIuZXF1YWwgKyBjb3VudGVyLmRlbGV0ZTsKICAgICAgICAgICAgICB2YXIgdmlld0NoaWxkID0gdmlld0VsZW1lbnQuZ2V0Q2hpbGQoaW5zZXJ0SW5kZXgpOyAvLyBUaGUgJ3VpRWxlbWVudCcgaXMgYSBzcGVjaWFsIG9uZSBhbmQgaXRzIGNoaWxkcmVuIGFyZSBub3Qgc3RvcmVkIGluIGEgdmlldyAoIzc5OSksCiAgICAgICAgICAgICAgLy8gc28gd2UgY2Fubm90IHVzZSBpdCB3aXRoIHJlcGxhY2luZyBmbG93IChzaW5jZSBpdCB1c2VzIHZpZXcgY2hpbGRyZW4gZHVyaW5nIHJlbmRlcmluZwogICAgICAgICAgICAgIC8vIHdoaWNoIHdpbGwgYWx3YXlzIHJlc3VsdCBpbiByZW5kZXJpbmcgZW1wdHkgZWxlbWVudCkuCgogICAgICAgICAgICAgIGlmICh2aWV3Q2hpbGQgJiYgIXZpZXdDaGlsZC5pcygndWlFbGVtZW50JykpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUVsZW1lbnRNYXBwaW5ncyh2aWV3Q2hpbGQsIGFjdHVhbERvbUNoaWxkcmVuW2RlbGV0ZUluZGV4XSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZW1vdmUoZXhwZWN0ZWREb21DaGlsZHJlbltpbnNlcnRJbmRleF0pOwogICAgICAgICAgICAgIGNvdW50ZXIuZXF1YWwrKzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb3VudGVyW2FjdGlvbl0rKzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgX2RpZEl0ZXJhdG9yRXJyb3I1ID0gdHJ1ZTsKICAgICAgICAgIF9pdGVyYXRvckVycm9yNSA9IGVycjsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKCFfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uNSAmJiBfaXRlcmF0b3I1LnJldHVybiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgX2l0ZXJhdG9yNS5yZXR1cm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgaWYgKF9kaWRJdGVyYXRvckVycm9yNSkgewogICAgICAgICAgICAgIHRocm93IF9pdGVyYXRvckVycm9yNTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGVzIG1hcHBpbmdzIG9mIGEgZ2l2ZW4gdmlldyBlbGVtZW50LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9ub2Rlfk5vZGV9IHZpZXdFbGVtZW50IFRoZSB2aWV3IGVsZW1lbnQgd2hvc2UgbWFwcGluZ3Mgd2lsbCBiZSB1cGRhdGVkLgogICAgICogQHBhcmFtIHtOb2RlfSBkb21FbGVtZW50IFRoZSBET00gZWxlbWVudCByZXByZXNlbnRpbmcgdGhlIGdpdmVuIHZpZXcgZWxlbWVudC4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlRWxlbWVudE1hcHBpbmdzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlRWxlbWVudE1hcHBpbmdzKHZpZXdFbGVtZW50LCBkb21FbGVtZW50KSB7CiAgICAgIC8vIFJlbWFwICdEb21Db252ZXJ0ZXInIGJpbmRpbmdzLgogICAgICB0aGlzLmRvbUNvbnZlcnRlci51bmJpbmREb21FbGVtZW50KGRvbUVsZW1lbnQpOwogICAgICB0aGlzLmRvbUNvbnZlcnRlci5iaW5kRWxlbWVudHMoZG9tRWxlbWVudCwgdmlld0VsZW1lbnQpOyAvLyBWaWV3IGVsZW1lbnQgbWF5IGhhdmUgY2hpbGRyZW4gd2hpY2ggbmVlZHMgdG8gYmUgdXBkYXRlZCwgYnV0IGFyZSBub3QgbWFya2VkLCBtYXJrIHRoZW0gdG8gdXBkYXRlLgoKICAgICAgdGhpcy5tYXJrZWRDaGlsZHJlbi5hZGQodmlld0VsZW1lbnQpOyAvLyBCZWNhdXNlIHdlIHJlcGxhY2UgbmV3IHZpZXcgZWxlbWVudCBtYXBwaW5nIHdpdGggdGhlIGV4aXN0aW5nIG9uZSwgdGhlIGNvcnJlc3BvbmRpbmcgRE9NIGVsZW1lbnQKICAgICAgLy8gd2lsbCBub3QgYmUgcmVyZW5kZXJlZC4gVGhlIG5ldyB2aWV3IGVsZW1lbnQgbWF5IGhhdmUgZGlmZmVyZW50IGF0dHJpYnV0ZXMgdGhhbiB0aGUgcHJldmlvdXMgb25lLgogICAgICAvLyBTaW5jZSBpdHMgY29ycmVzcG9uZGluZyBET00gZWxlbWVudCB3aWxsIG5vdCBiZSByZXJlbmRlcmVkLCBuZXcgYXR0cmlidXRlcyB3aWxsIG5vdCBiZSBhZGRlZAogICAgICAvLyB0byB0aGUgRE9NLCBzbyB3ZSBuZWVkIHRvIG1hcmsgaXQgaGVyZSB0byBtYWtlIHN1cmUgaXRzIGF0dHJpYnV0ZXMgZ2V0cyB1cGRhdGVkLiBTZWUgIzE0MjcgZm9yIG1vcmUKICAgICAgLy8gZGV0YWlsZWQgY2FzZSBzdHVkeS4KICAgICAgLy8gQWxzbyB0aGVyZSBhcmUgY2FzZXMgd2hlcmUgcmVwbGFjZWQgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIHZpZXcgc3RydWN0dXJlIGFuZCB0aGVuIGhhcwogICAgICAvLyBpdHMgYXR0cmlidXRlcyBjaGFuZ2VkIG9yIHJlbW92ZWQuIEluIHN1Y2ggY2FzZXMgdGhlIGVsZW1lbnQgd2lsbCBub3QgYmUgcHJlc2VudCBpbiBgbWFya2VkQXR0cmlidXRlc2AKICAgICAgLy8gYW5kIGFsc28gbWF5IGJlIHRoZSBzYW1lIChgZWxlbWVudC5pc1NpbWlsYXIoKWApIGFzIHRoZSByZXVzZWQgZWxlbWVudCBub3QgaGF2aW5nIGl0cyBhdHRyaWJ1dGVzIHVwZGF0ZWQuCiAgICAgIC8vIFRvIHByZXZlbnQgc3VjaCBzaXR1YXRpb25zIHdlIGFsd2F5cyBtYXJrIHJldXNlZCBlbGVtZW50IHRvIGhhdmUgaXRzIGF0dHJpYnV0ZXMgcmVyZW5kZXJkICgjMTU2MCkuCgogICAgICB0aGlzLm1hcmtlZEF0dHJpYnV0ZXMuYWRkKHZpZXdFbGVtZW50KTsKICAgIH0KICAgIC8qKgogICAgICogR2V0cyB0aGUgcG9zaXRpb24gb2YgdGhlIGlubGluZSBmaWxsZXIgYmFzZWQgb24gdGhlIGN1cnJlbnQgc2VsZWN0aW9uLgogICAgICogSGVyZSwgd2UgYXNzdW1lIHRoYXQgd2Uga25vdyB0aGF0IHRoZSBmaWxsZXIgaXMgbmVlZGVkIGFuZAogICAgICoge0BsaW5rICNfaXNTZWxlY3Rpb25JbklubGluZUZpbGxlciBpcyBhdCB0aGUgc2VsZWN0aW9uIHBvc2l0aW9ufSwgYW5kLCBzaW5jZSBpdCBpcyBuZWVkZWQsCiAgICAgKiBpdCBpcyBzb21ld2hlcmUgYXQgdGhlIHNlbGVjdGlvbiBwb3NpdGlvbi4KICAgICAqCiAgICAgKiBOb3RlOiBUaGUgZmlsbGVyIHBvc2l0aW9uIGNhbm5vdCBiZSByZXN0b3JlZCBiYXNlZCBvbiB0aGUgZmlsbGVyJ3MgRE9NIHRleHQgbm9kZSwgYmVjYXVzZQogICAgICogd2hlbiB0aGlzIG1ldGhvZCBpcyBjYWxsZWQgKGJlZm9yZSByZW5kZXJpbmcpLCB0aGUgYmluZGluZ3Mgd2lsbCBvZnRlbiBiZSBicm9rZW4uIFZpZXctdG8tRE9NCiAgICAgKiBiaW5kaW5ncyBhcmUgb25seSBkZXBlbmRhYmxlIGFmdGVyIHJlbmRlcmluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHJldHVybnMge21vZHVsZTplbmdpbmUvdmlldy9wb3NpdGlvbn5Qb3NpdGlvbn0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfZ2V0SW5saW5lRmlsbGVyUG9zaXRpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXRJbmxpbmVGaWxsZXJQb3NpdGlvbigpIHsKICAgICAgdmFyIGZpcnN0UG9zID0gdGhpcy5zZWxlY3Rpb24uZ2V0Rmlyc3RQb3NpdGlvbigpOwoKICAgICAgaWYgKGZpcnN0UG9zLnBhcmVudC5pcygndGV4dCcpKSB7CiAgICAgICAgcmV0dXJuIFZpZXdQb3NpdGlvbi5fY3JlYXRlQmVmb3JlKHRoaXMuc2VsZWN0aW9uLmdldEZpcnN0UG9zaXRpb24oKS5wYXJlbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmaXJzdFBvczsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgc2VsZWN0aW9uIGhhcyBub3QgbGVmdCB0aGUgaW5saW5lIGZpbGxlcidzIHRleHQgbm9kZS4KICAgICAqIElmIGl0IGlzIGB0cnVlYCwgaXQgbWVhbnMgdGhhdCB0aGUgZmlsbGVyIGhhZCBiZWVuIGFkZGVkIGZvciBhIHJlYXNvbiBhbmQgdGhlIHNlbGVjdGlvbiBkaWQgbm90CiAgICAgKiBsZWF2ZSB0aGUgZmlsbGVyJ3MgdGV4dCBub2RlLiBGb3IgZXhhbXBsZSwgdGhlIHVzZXIgY2FuIGJlIGluIHRoZSBtaWRkbGUgb2YgYSBjb21wb3NpdGlvbiBzbyBpdCBzaG91bGQgbm90IGJlIHRvdWNoZWQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBgdHJ1ZWAgaWYgdGhlIGlubGluZSBmaWxsZXIgYW5kIHNlbGVjdGlvbiBhcmUgaW4gdGhlIHNhbWUgcGxhY2UuCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX2lzU2VsZWN0aW9uSW5JbmxpbmVGaWxsZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9pc1NlbGVjdGlvbkluSW5saW5lRmlsbGVyKCkgewogICAgICBpZiAodGhpcy5zZWxlY3Rpb24ucmFuZ2VDb3VudCAhPSAxIHx8ICF0aGlzLnNlbGVjdGlvbi5pc0NvbGxhcHNlZCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSAvLyBOb3RlLCB3ZSBjYW4ndCBjaGVjayBpZiBzZWxlY3Rpb24ncyBwb3NpdGlvbiBlcXVhbHMgcG9zaXRpb24gb2YgdGhlCiAgICAgIC8vIHRoaXMuX2lubGluZUZpbGxlciBub2RlLCBiZWNhdXNlIG9mICM2NjMuIFdlIG1heSBub3QgYmUgYWJsZSB0byBjYWxjdWxhdGUKICAgICAgLy8gdGhlIGZpbGxlcidzIHBvc2l0aW9uIGluIHRoZSB2aWV3IGF0IHRoaXMgc3RhZ2UuCiAgICAgIC8vIEluc3RlYWQsIHdlIGNoZWNrIGl0IHRoZSBvdGhlciB3YXkg4oCTIHdoZXRoZXIgc2VsZWN0aW9uIGlzIGFuY2hvcmVkIGluCiAgICAgIC8vIHRoYXQgdGV4dCBub2RlIG9yIG5leHQgdG8gaXQuCiAgICAgIC8vIFBvc3NpYmxlIG9wdGlvbnMgYXJlOgogICAgICAvLyAiRklMTEVSe30iCiAgICAgIC8vICJGSUxMRVJhZGRlZC10ZXh0e30iCgoKICAgICAgdmFyIHNlbGVjdGlvblBvc2l0aW9uID0gdGhpcy5zZWxlY3Rpb24uZ2V0Rmlyc3RQb3NpdGlvbigpOwogICAgICB2YXIgcG9zaXRpb24gPSB0aGlzLmRvbUNvbnZlcnRlci52aWV3UG9zaXRpb25Ub0RvbShzZWxlY3Rpb25Qb3NpdGlvbik7CgogICAgICBpZiAocG9zaXRpb24gJiYgaXNUZXh0KHBvc2l0aW9uLnBhcmVudCkgJiYgc3RhcnRzV2l0aEZpbGxlcihwb3NpdGlvbi5wYXJlbnQpKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlcyB0aGUgaW5saW5lIGZpbGxlci4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCgogIH0sIHsKICAgIGtleTogIl9yZW1vdmVJbmxpbmVGaWxsZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9yZW1vdmVJbmxpbmVGaWxsZXIoKSB7CiAgICAgIHZhciBkb21GaWxsZXJOb2RlID0gdGhpcy5faW5saW5lRmlsbGVyOyAvLyBTb21ldGhpbmcgd2VpcmQgaGFwcGVuZWQgYW5kIHRoZSBzdG9yZWQgbm9kZSBkb2Vzbid0IGNvbnRhaW4gdGhlIGZpbGxlcidzIHRleHQuCgogICAgICBpZiAoIXN0YXJ0c1dpdGhGaWxsZXIoZG9tRmlsbGVyTm9kZSkpIHsKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgaW5saW5lIGZpbGxlciBub2RlIHdhcyBsb3N0LiBNb3N0IGxpa2VseSwgc29tZXRoaW5nIG92ZXJ3cm90ZSB0aGUgZmlsbGVyIHRleHQgbm9kZQogICAgICAgICAqIGluIHRoZSBET00uCiAgICAgICAgICoKICAgICAgICAgKiBAZXJyb3Igdmlldy1yZW5kZXJlci1maWxsZXItd2FzLWxvc3QKICAgICAgICAgKi8KICAgICAgICB0aHJvdyBuZXcgQ0tFZGl0b3JFcnJvcigndmlldy1yZW5kZXJlci1maWxsZXItd2FzLWxvc3Q6IFRoZSBpbmxpbmUgZmlsbGVyIG5vZGUgd2FzIGxvc3QuJywgdGhpcyk7CiAgICAgIH0KCiAgICAgIGlmIChpc0lubGluZUZpbGxlcihkb21GaWxsZXJOb2RlKSkgewogICAgICAgIGRvbUZpbGxlck5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChkb21GaWxsZXJOb2RlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkb21GaWxsZXJOb2RlLmRhdGEgPSBkb21GaWxsZXJOb2RlLmRhdGEuc3Vic3RyKElOTElORV9GSUxMRVJfTEVOR1RIKTsKICAgICAgfQoKICAgICAgdGhpcy5faW5saW5lRmlsbGVyID0gbnVsbDsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2tzIGlmIHRoZSBpbmxpbmUge0BsaW5rIG1vZHVsZTplbmdpbmUvdmlldy9maWxsZXIgZmlsbGVyfSBzaG91bGQgYmUgYWRkZWQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBgdHJ1ZWAgaWYgdGhlIGlubGluZSBmaWxsZXIgc2hvdWxkIGJlIGFkZGVkLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9uZWVkc0lubGluZUZpbGxlckF0U2VsZWN0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfbmVlZHNJbmxpbmVGaWxsZXJBdFNlbGVjdGlvbigpIHsKICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uLnJhbmdlQ291bnQgIT0gMSB8fCAhdGhpcy5zZWxlY3Rpb24uaXNDb2xsYXBzZWQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHZhciBzZWxlY3Rpb25Qb3NpdGlvbiA9IHRoaXMuc2VsZWN0aW9uLmdldEZpcnN0UG9zaXRpb24oKTsKICAgICAgdmFyIHNlbGVjdGlvblBhcmVudCA9IHNlbGVjdGlvblBvc2l0aW9uLnBhcmVudDsKICAgICAgdmFyIHNlbGVjdGlvbk9mZnNldCA9IHNlbGVjdGlvblBvc2l0aW9uLm9mZnNldDsgLy8gSWYgdGhlcmUgaXMgbm8gRE9NIHJvb3Qgd2UgZG8gbm90IGNhcmUgYWJvdXQgZmlsbGVycy4KCiAgICAgIGlmICghdGhpcy5kb21Db252ZXJ0ZXIubWFwVmlld1RvRG9tKHNlbGVjdGlvblBhcmVudC5yb290KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKCFzZWxlY3Rpb25QYXJlbnQuaXMoJ2VsZW1lbnQnKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSAvLyBQcmV2ZW50IGFkZGluZyBpbmxpbmUgZmlsbGVyIGluc2lkZSBlbGVtZW50cyB3aXRoIGNvbnRlbnRlZGl0YWJsZT1mYWxzZS4KICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NrZWRpdG9yL2NrZWRpdG9yNS1lbmdpbmUvaXNzdWVzLzExNzAKCgogICAgICBpZiAoIWlzRWRpdGFibGUoc2VsZWN0aW9uUGFyZW50KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSAvLyBXZSBoYXZlIGJsb2NrIGZpbGxlciwgd2UgZG8gbm90IG5lZWQgaW5saW5lIG9uZS4KCgogICAgICBpZiAoc2VsZWN0aW9uT2Zmc2V0ID09PSBzZWxlY3Rpb25QYXJlbnQuZ2V0RmlsbGVyT2Zmc2V0KCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHZhciBub2RlQmVmb3JlID0gc2VsZWN0aW9uUG9zaXRpb24ubm9kZUJlZm9yZTsKICAgICAgdmFyIG5vZGVBZnRlciA9IHNlbGVjdGlvblBvc2l0aW9uLm5vZGVBZnRlcjsKCiAgICAgIGlmIChub2RlQmVmb3JlIGluc3RhbmNlb2YgVmlld1RleHQgfHwgbm9kZUFmdGVyIGluc3RhbmNlb2YgVmlld1RleHQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgdGV4dCBuZWVkcyB0byBiZSB1cGRhdGVkIGFuZCBwb3NzaWJseSB1cGRhdGVzIGl0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy90ZXh0flRleHR9IHZpZXdUZXh0IFZpZXcgdGV4dCB0byB1cGRhdGUuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvcG9zaXRpb25+UG9zaXRpb259IG9wdGlvbnMuaW5saW5lRmlsbGVyUG9zaXRpb24gVGhlIHBvc2l0aW9uIHdoZXJlIHRoZSBpbmxpbmUKICAgICAqIGZpbGxlciBzaG91bGQgYmUgcmVuZGVyZWQuCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX3VwZGF0ZVRleHQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVUZXh0KHZpZXdUZXh0LCBvcHRpb25zKSB7CiAgICAgIHZhciBkb21UZXh0ID0gdGhpcy5kb21Db252ZXJ0ZXIuZmluZENvcnJlc3BvbmRpbmdEb21UZXh0KHZpZXdUZXh0KTsKICAgICAgdmFyIG5ld0RvbVRleHQgPSB0aGlzLmRvbUNvbnZlcnRlci52aWV3VG9Eb20odmlld1RleHQsIGRvbVRleHQub3duZXJEb2N1bWVudCk7CiAgICAgIHZhciBhY3R1YWxUZXh0ID0gZG9tVGV4dC5kYXRhOwogICAgICB2YXIgZXhwZWN0ZWRUZXh0ID0gbmV3RG9tVGV4dC5kYXRhOwogICAgICB2YXIgZmlsbGVyID0gb3B0aW9ucy5pbmxpbmVGaWxsZXJQb3NpdGlvbjsKCiAgICAgIGlmIChmaWxsZXIgJiYgZmlsbGVyLnBhcmVudCA9PSB2aWV3VGV4dC5wYXJlbnQgJiYgZmlsbGVyLm9mZnNldCA9PSB2aWV3VGV4dC5pbmRleCkgewogICAgICAgIGV4cGVjdGVkVGV4dCA9IElOTElORV9GSUxMRVIgKyBleHBlY3RlZFRleHQ7CiAgICAgIH0KCiAgICAgIGlmIChhY3R1YWxUZXh0ICE9IGV4cGVjdGVkVGV4dCkgewogICAgICAgIHZhciBhY3Rpb25zID0gZmFzdERpZmYoYWN0dWFsVGV4dCwgZXhwZWN0ZWRUZXh0KTsKICAgICAgICB2YXIgX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjYgPSB0cnVlOwogICAgICAgIHZhciBfZGlkSXRlcmF0b3JFcnJvcjYgPSBmYWxzZTsKICAgICAgICB2YXIgX2l0ZXJhdG9yRXJyb3I2ID0gdW5kZWZpbmVkOwoKICAgICAgICB0cnkgewogICAgICAgICAgZm9yICh2YXIgX2l0ZXJhdG9yNiA9IGFjdGlvbnNbU3ltYm9sLml0ZXJhdG9yXSgpLCBfc3RlcDY7ICEoX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjYgPSAoX3N0ZXA2ID0gX2l0ZXJhdG9yNi5uZXh0KCkpLmRvbmUpOyBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uNiA9IHRydWUpIHsKICAgICAgICAgICAgdmFyIGFjdGlvbiA9IF9zdGVwNi52YWx1ZTsKCiAgICAgICAgICAgIGlmIChhY3Rpb24udHlwZSA9PT0gJ2luc2VydCcpIHsKICAgICAgICAgICAgICBkb21UZXh0Lmluc2VydERhdGEoYWN0aW9uLmluZGV4LCBhY3Rpb24udmFsdWVzLmpvaW4oJycpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyAnZGVsZXRlJwogICAgICAgICAgICAgIGRvbVRleHQuZGVsZXRlRGF0YShhY3Rpb24uaW5kZXgsIGFjdGlvbi5ob3dNYW55KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgX2RpZEl0ZXJhdG9yRXJyb3I2ID0gdHJ1ZTsKICAgICAgICAgIF9pdGVyYXRvckVycm9yNiA9IGVycjsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKCFfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uNiAmJiBfaXRlcmF0b3I2LnJldHVybiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgX2l0ZXJhdG9yNi5yZXR1cm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgaWYgKF9kaWRJdGVyYXRvckVycm9yNikgewogICAgICAgICAgICAgIHRocm93IF9pdGVyYXRvckVycm9yNjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYXR0cmlidXRlIGxpc3QgbmVlZHMgdG8gYmUgdXBkYXRlZCBhbmQgcG9zc2libHkgdXBkYXRlcyBpdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvZWxlbWVudH5FbGVtZW50fSB2aWV3RWxlbWVudCBUaGUgdmlldyBlbGVtZW50IHRvIHVwZGF0ZS4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlQXR0cnMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVBdHRycyh2aWV3RWxlbWVudCkgewogICAgICB2YXIgZG9tRWxlbWVudCA9IHRoaXMuZG9tQ29udmVydGVyLm1hcFZpZXdUb0RvbSh2aWV3RWxlbWVudCk7CgogICAgICBpZiAoIWRvbUVsZW1lbnQpIHsKICAgICAgICAvLyBJZiB0aGVyZSBpcyBubyBgZG9tRWxlbWVudGAgaXQgbWVhbnMgdGhhdCAndmlld0VsZW1lbnQnIGlzIG91dGRhdGVkIGFzIGl0cyBtYXBwaW5nIHdhcyB1cGRhdGVkCiAgICAgICAgLy8gaW4gJ3RoaXMuX3VwZGF0ZUNoaWxkcmVuTWFwcGluZ3MoKScuIFRoZXJlIGlzIG5vIG5lZWQgdG8gcHJvY2VzcyBpdCBhcyBuZXcgdmlldyBlbGVtZW50IHdoaWNoCiAgICAgICAgLy8gcmVwbGFjZWQgb2xkICd2aWV3RWxlbWVudCcgbWFwcGluZyB3YXMgYWxzbyBhZGRlZCB0byAndGhpcy5tYXJrZWRBdHRyaWJ1dGVzJwogICAgICAgIC8vIGluICd0aGlzLl91cGRhdGVDaGlsZHJlbk1hcHBpbmdzKCknIHNvIGl0IHdpbGwgYmUgcHJvY2Vzc2VkIHNlcGFyYXRlbHkuCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgZG9tQXR0cktleXMgPSBBcnJheS5mcm9tKGRvbUVsZW1lbnQuYXR0cmlidXRlcykubWFwKGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgICAgcmV0dXJuIGF0dHIubmFtZTsKICAgICAgfSk7CiAgICAgIHZhciB2aWV3QXR0cktleXMgPSB2aWV3RWxlbWVudC5nZXRBdHRyaWJ1dGVLZXlzKCk7IC8vIEFkZCBvciBvdmVyd3JpdGUgYXR0cmlidXRlcy4KCiAgICAgIHZhciBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uNyA9IHRydWU7CiAgICAgIHZhciBfZGlkSXRlcmF0b3JFcnJvcjcgPSBmYWxzZTsKICAgICAgdmFyIF9pdGVyYXRvckVycm9yNyA9IHVuZGVmaW5lZDsKCiAgICAgIHRyeSB7CiAgICAgICAgZm9yICh2YXIgX2l0ZXJhdG9yNyA9IHZpZXdBdHRyS2V5c1tTeW1ib2wuaXRlcmF0b3JdKCksIF9zdGVwNzsgIShfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uNyA9IChfc3RlcDcgPSBfaXRlcmF0b3I3Lm5leHQoKSkuZG9uZSk7IF9pdGVyYXRvck5vcm1hbENvbXBsZXRpb243ID0gdHJ1ZSkgewogICAgICAgICAgdmFyIGtleSA9IF9zdGVwNy52YWx1ZTsKICAgICAgICAgIGRvbUVsZW1lbnQuc2V0QXR0cmlidXRlKGtleSwgdmlld0VsZW1lbnQuZ2V0QXR0cmlidXRlKGtleSkpOwogICAgICAgIH0gLy8gUmVtb3ZlIGZyb20gRE9NIGF0dHJpYnV0ZXMgd2hpY2ggZG8gbm90IGV4aXN0cyBpbiB0aGUgdmlldy4KCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIF9kaWRJdGVyYXRvckVycm9yNyA9IHRydWU7CiAgICAgICAgX2l0ZXJhdG9yRXJyb3I3ID0gZXJyOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoIV9pdGVyYXRvck5vcm1hbENvbXBsZXRpb243ICYmIF9pdGVyYXRvcjcucmV0dXJuICE9IG51bGwpIHsKICAgICAgICAgICAgX2l0ZXJhdG9yNy5yZXR1cm4oKTsKICAgICAgICAgIH0KICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKF9kaWRJdGVyYXRvckVycm9yNykgewogICAgICAgICAgICB0aHJvdyBfaXRlcmF0b3JFcnJvcjc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjggPSB0cnVlOwogICAgICB2YXIgX2RpZEl0ZXJhdG9yRXJyb3I4ID0gZmFsc2U7CiAgICAgIHZhciBfaXRlcmF0b3JFcnJvcjggPSB1bmRlZmluZWQ7CgogICAgICB0cnkgewogICAgICAgIGZvciAodmFyIF9pdGVyYXRvcjggPSBkb21BdHRyS2V5c1tTeW1ib2wuaXRlcmF0b3JdKCksIF9zdGVwODsgIShfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uOCA9IChfc3RlcDggPSBfaXRlcmF0b3I4Lm5leHQoKSkuZG9uZSk7IF9pdGVyYXRvck5vcm1hbENvbXBsZXRpb244ID0gdHJ1ZSkgewogICAgICAgICAgdmFyIF9rZXkgPSBfc3RlcDgudmFsdWU7CgogICAgICAgICAgaWYgKCF2aWV3RWxlbWVudC5oYXNBdHRyaWJ1dGUoX2tleSkpIHsKICAgICAgICAgICAgZG9tRWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoX2tleSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBfZGlkSXRlcmF0b3JFcnJvcjggPSB0cnVlOwogICAgICAgIF9pdGVyYXRvckVycm9yOCA9IGVycjsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICB0cnkgewogICAgICAgICAgaWYgKCFfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uOCAmJiBfaXRlcmF0b3I4LnJldHVybiAhPSBudWxsKSB7CiAgICAgICAgICAgIF9pdGVyYXRvcjgucmV0dXJuKCk7CiAgICAgICAgICB9CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChfZGlkSXRlcmF0b3JFcnJvcjgpIHsKICAgICAgICAgICAgdGhyb3cgX2l0ZXJhdG9yRXJyb3I4OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgZWxlbWVudHMgY2hpbGQgbGlzdCBuZWVkcyB0byBiZSB1cGRhdGVkIGFuZCBwb3NzaWJseSB1cGRhdGVzIGl0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9lbGVtZW50fkVsZW1lbnR9IHZpZXdFbGVtZW50IFZpZXcgZWxlbWVudCB0byB1cGRhdGUuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvcG9zaXRpb25+UG9zaXRpb259IG9wdGlvbnMuaW5saW5lRmlsbGVyUG9zaXRpb24gVGhlIHBvc2l0aW9uIHdoZXJlIHRoZSBpbmxpbmUKICAgICAqIGZpbGxlciBzaG91bGQgYmUgcmVuZGVyZWQuCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX3VwZGF0ZUNoaWxkcmVuIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlQ2hpbGRyZW4odmlld0VsZW1lbnQsIG9wdGlvbnMpIHsKICAgICAgdmFyIGRvbUVsZW1lbnQgPSB0aGlzLmRvbUNvbnZlcnRlci5tYXBWaWV3VG9Eb20odmlld0VsZW1lbnQpOwoKICAgICAgaWYgKCFkb21FbGVtZW50KSB7CiAgICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gYGRvbUVsZW1lbnRgIGl0IG1lYW5zIHRoYXQgaXQgd2FzIGFscmVhZHkgcmVtb3ZlZCBmcm9tIERPTS4KICAgICAgICAvLyBUaGVyZSBpcyBubyBuZWVkIHRvIHByb2Nlc3MgaXQuIEl0IHdpbGwgYmUgcHJvY2Vzc2VkIHdoZW4gcmUtaW5zZXJ0ZWQuCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgaW5saW5lRmlsbGVyUG9zaXRpb24gPSBvcHRpb25zLmlubGluZUZpbGxlclBvc2l0aW9uOwogICAgICB2YXIgYWN0dWFsRG9tQ2hpbGRyZW4gPSB0aGlzLmRvbUNvbnZlcnRlci5tYXBWaWV3VG9Eb20odmlld0VsZW1lbnQpLmNoaWxkTm9kZXM7CiAgICAgIHZhciBleHBlY3RlZERvbUNoaWxkcmVuID0gQXJyYXkuZnJvbSh0aGlzLmRvbUNvbnZlcnRlci52aWV3Q2hpbGRyZW5Ub0RvbSh2aWV3RWxlbWVudCwgZG9tRWxlbWVudC5vd25lckRvY3VtZW50LCB7CiAgICAgICAgYmluZDogdHJ1ZSwKICAgICAgICBpbmxpbmVGaWxsZXJQb3NpdGlvbjogaW5saW5lRmlsbGVyUG9zaXRpb24KICAgICAgfSkpOyAvLyBJbmxpbmUgZmlsbGVyIGVsZW1lbnQgaGFzIHRvIGJlIGNyZWF0ZWQgYXMgaXQgaXMgcHJlc2VudCBpbiB0aGUgRE9NLCBidXQgbm90IGluIHRoZSB2aWV3LiBJdCBpcyByZXF1aXJlZAogICAgICAvLyBkdXJpbmcgZGlmZmluZyBzbyB0ZXh0IG5vZGVzIGNvdWxkIGJlIGNvbXBhcmVkIGNvcnJlY3RseSBhbmQgYWxzbyBkdXJpbmcgcmVuZGVyaW5nIHRvIG1haW50YWluCiAgICAgIC8vIHByb3BlciBvcmRlciBhbmQgaW5kZXhlcyB3aGlsZSB1cGRhdGluZyB0aGUgRE9NLgoKICAgICAgaWYgKGlubGluZUZpbGxlclBvc2l0aW9uICYmIGlubGluZUZpbGxlclBvc2l0aW9uLnBhcmVudCA9PT0gdmlld0VsZW1lbnQpIHsKICAgICAgICBhZGRJbmxpbmVGaWxsZXIoZG9tRWxlbWVudC5vd25lckRvY3VtZW50LCBleHBlY3RlZERvbUNoaWxkcmVuLCBpbmxpbmVGaWxsZXJQb3NpdGlvbi5vZmZzZXQpOwogICAgICB9CgogICAgICB2YXIgZGlmZiA9IHRoaXMuX2RpZmZOb2RlTGlzdHMoYWN0dWFsRG9tQ2hpbGRyZW4sIGV4cGVjdGVkRG9tQ2hpbGRyZW4pOwoKICAgICAgdmFyIGkgPSAwOwogICAgICB2YXIgbm9kZXNUb1VuYmluZCA9IG5ldyBTZXQoKTsgLy8gSGFuZGxlIGRlbGV0aW9ucyBmaXJzdC4KICAgICAgLy8gVGhpcyBpcyB0byBwcmV2ZW50IGEgc2l0dWF0aW9uIHdoZXJlIGFuIGVsZW1lbnQgdGhhdCBhbHJlYWR5IGV4aXN0cyBpbiBgYWN0dWFsRG9tQ2hpbGRyZW5gIGlzIGluc2VydGVkIGF0IGEgZGlmZmVyZW50CiAgICAgIC8vIGluZGV4IGluIGBhY3R1YWxEb21DaGlsZHJlbmAuIFNpbmNlIGBhY3R1YWxEb21DaGlsZHJlbmAgaXMgYSBgTm9kZUxpc3RgLCB0aGlzIHdvcmtzIGxpa2UgbW92ZSwgbm90IGxpa2UgYW4gaW5zZXJ0LAogICAgICAvLyBhbmQgaXQgZGlzcnVwdHMgdGhlIHdob2xlIGFsZ29yaXRobS4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9ja2VkaXRvci9ja2VkaXRvcjUvaXNzdWVzLzYzNjcuCiAgICAgIC8vCiAgICAgIC8vIEl0IGRvZXNuJ3QgbWF0dGVyIGluIHdoYXQgb3JkZXIgd2UgcmVtb3ZlIG9yIGFkZCBub2RlcywgYXMgbG9uZyBhcyB3ZSByZW1vdmUgYW5kIGFkZCBjb3JyZWN0IG5vZGVzIGF0IGNvcnJlY3QgaW5kZXhlcy4KCiAgICAgIHZhciBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uOSA9IHRydWU7CiAgICAgIHZhciBfZGlkSXRlcmF0b3JFcnJvcjkgPSBmYWxzZTsKICAgICAgdmFyIF9pdGVyYXRvckVycm9yOSA9IHVuZGVmaW5lZDsKCiAgICAgIHRyeSB7CiAgICAgICAgZm9yICh2YXIgX2l0ZXJhdG9yOSA9IGRpZmZbU3ltYm9sLml0ZXJhdG9yXSgpLCBfc3RlcDk7ICEoX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjkgPSAoX3N0ZXA5ID0gX2l0ZXJhdG9yOS5uZXh0KCkpLmRvbmUpOyBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uOSA9IHRydWUpIHsKICAgICAgICAgIHZhciBhY3Rpb24gPSBfc3RlcDkudmFsdWU7CgogICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ2RlbGV0ZScpIHsKICAgICAgICAgICAgbm9kZXNUb1VuYmluZC5hZGQoYWN0dWFsRG9tQ2hpbGRyZW5baV0pOwogICAgICAgICAgICByZW1vdmUoYWN0dWFsRG9tQ2hpbGRyZW5baV0pOwogICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdlcXVhbCcpIHsKICAgICAgICAgICAgaSsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2RpZEl0ZXJhdG9yRXJyb3I5ID0gdHJ1ZTsKICAgICAgICBfaXRlcmF0b3JFcnJvcjkgPSBlcnI7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmICghX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjkgJiYgX2l0ZXJhdG9yOS5yZXR1cm4gIT0gbnVsbCkgewogICAgICAgICAgICBfaXRlcmF0b3I5LnJldHVybigpOwogICAgICAgICAgfQogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAoX2RpZEl0ZXJhdG9yRXJyb3I5KSB7CiAgICAgICAgICAgIHRocm93IF9pdGVyYXRvckVycm9yOTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGkgPSAwOwogICAgICB2YXIgX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjEwID0gdHJ1ZTsKICAgICAgdmFyIF9kaWRJdGVyYXRvckVycm9yMTAgPSBmYWxzZTsKICAgICAgdmFyIF9pdGVyYXRvckVycm9yMTAgPSB1bmRlZmluZWQ7CgogICAgICB0cnkgewogICAgICAgIGZvciAodmFyIF9pdGVyYXRvcjEwID0gZGlmZltTeW1ib2wuaXRlcmF0b3JdKCksIF9zdGVwMTA7ICEoX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjEwID0gKF9zdGVwMTAgPSBfaXRlcmF0b3IxMC5uZXh0KCkpLmRvbmUpOyBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uMTAgPSB0cnVlKSB7CiAgICAgICAgICB2YXIgX2FjdGlvbiA9IF9zdGVwMTAudmFsdWU7CgogICAgICAgICAgaWYgKF9hY3Rpb24gPT09ICdpbnNlcnQnKSB7CiAgICAgICAgICAgIGluc2VydEF0KGRvbUVsZW1lbnQsIGksIGV4cGVjdGVkRG9tQ2hpbGRyZW5baV0pOwogICAgICAgICAgICBpKys7CiAgICAgICAgICB9IGVsc2UgaWYgKF9hY3Rpb24gPT09ICdlcXVhbCcpIHsKICAgICAgICAgICAgLy8gRm9yY2UgdXBkYXRpbmcgdGV4dCBub2RlcyBpbnNpZGUgZWxlbWVudHMgd2hpY2ggZGlkIG5vdCBjaGFuZ2UgYW5kIGRvIG5vdCBuZWVkIHRvIGJlIHJlLXJlbmRlcmVkICgjMTEyNSkuCiAgICAgICAgICAgIC8vIERvIGl0IGhlcmUgKG5vdCBpbiB0aGUgbG9vcCBhYm92ZSkgYmVjYXVzZSBvbmx5IGFmdGVyIGluc2VydGlvbnMgdGhlIGBpYCBpbmRleCBpcyBjb3JyZWN0LgogICAgICAgICAgICB0aGlzLl9tYXJrRGVzY2VuZGFudFRleHRUb1N5bmModGhpcy5kb21Db252ZXJ0ZXIuZG9tVG9WaWV3KGV4cGVjdGVkRG9tQ2hpbGRyZW5baV0pKTsKCiAgICAgICAgICAgIGkrKzsKICAgICAgICAgIH0KICAgICAgICB9IC8vIFVuYmluZCByZW1vdmVkIG5vZGVzLiBXaGVuIG5vZGUgZG9lcyBub3QgaGF2ZSBhIHBhcmVudCBpdCBtZWFucyB0aGF0IGl0IHdhcyByZW1vdmVkIGZyb20gRE9NIHRyZWUgZHVyaW5nCiAgICAgICAgLy8gY29tcGFyaXNpb24gd2l0aCB0aGUgZXhwZWN0ZWQgRE9NLiBXZSBkb24ndCBuZWVkIHRvIGNoZWNrIGNoaWxkIG5vZGVzLCBiZWNhdXNlIGlmIGNoaWxkIG5vZGUgd2FzIHJlaW5zZXJ0ZWQsCiAgICAgICAgLy8gaXQgd2FzIG1vdmVkIHRvIERPTSB0cmVlIG91dCBvZiB0aGUgcmVtb3ZlZCBub2RlLgoKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2RpZEl0ZXJhdG9yRXJyb3IxMCA9IHRydWU7CiAgICAgICAgX2l0ZXJhdG9yRXJyb3IxMCA9IGVycjsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICB0cnkgewogICAgICAgICAgaWYgKCFfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uMTAgJiYgX2l0ZXJhdG9yMTAucmV0dXJuICE9IG51bGwpIHsKICAgICAgICAgICAgX2l0ZXJhdG9yMTAucmV0dXJuKCk7CiAgICAgICAgICB9CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChfZGlkSXRlcmF0b3JFcnJvcjEwKSB7CiAgICAgICAgICAgIHRocm93IF9pdGVyYXRvckVycm9yMTA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjExID0gdHJ1ZTsKICAgICAgdmFyIF9kaWRJdGVyYXRvckVycm9yMTEgPSBmYWxzZTsKICAgICAgdmFyIF9pdGVyYXRvckVycm9yMTEgPSB1bmRlZmluZWQ7CgogICAgICB0cnkgewogICAgICAgIGZvciAodmFyIF9pdGVyYXRvcjExID0gbm9kZXNUb1VuYmluZFtTeW1ib2wuaXRlcmF0b3JdKCksIF9zdGVwMTE7ICEoX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjExID0gKF9zdGVwMTEgPSBfaXRlcmF0b3IxMS5uZXh0KCkpLmRvbmUpOyBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uMTEgPSB0cnVlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IF9zdGVwMTEudmFsdWU7CgogICAgICAgICAgaWYgKCFub2RlLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgdGhpcy5kb21Db252ZXJ0ZXIudW5iaW5kRG9tRWxlbWVudChub2RlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIF9kaWRJdGVyYXRvckVycm9yMTEgPSB0cnVlOwogICAgICAgIF9pdGVyYXRvckVycm9yMTEgPSBlcnI7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmICghX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjExICYmIF9pdGVyYXRvcjExLnJldHVybiAhPSBudWxsKSB7CiAgICAgICAgICAgIF9pdGVyYXRvcjExLnJldHVybigpOwogICAgICAgICAgfQogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAoX2RpZEl0ZXJhdG9yRXJyb3IxMSkgewogICAgICAgICAgICB0aHJvdyBfaXRlcmF0b3JFcnJvcjExOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBTaG9ydGhhbmQgZm9yIGRpZmZpbmcgdHdvIGFycmF5cyBvciBub2RlIGxpc3RzIG9mIERPTSBub2Rlcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheS48Tm9kZT58Tm9kZUxpc3R9IGFjdHVhbERvbUNoaWxkcmVuIEFjdHVhbCBET00gY2hpbGRyZW4KICAgICAqIEBwYXJhbSB7QXJyYXkuPE5vZGU+fE5vZGVMaXN0fSBleHBlY3RlZERvbUNoaWxkcmVuIEV4cGVjdGVkIERPTSBjaGlsZHJlbi4KICAgICAqIEByZXR1cm5zIHtBcnJheS48U3RyaW5nPn0gVGhlIGxpc3Qgb2YgYWN0aW9ucyBiYXNlZCBvbiB0aGUge0BsaW5rIG1vZHVsZTp1dGlscy9kaWZmfmRpZmZ9IGZ1bmN0aW9uLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9kaWZmTm9kZUxpc3RzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZGlmZk5vZGVMaXN0cyhhY3R1YWxEb21DaGlsZHJlbiwgZXhwZWN0ZWREb21DaGlsZHJlbikgewogICAgICBhY3R1YWxEb21DaGlsZHJlbiA9IGZpbHRlck91dEZha2VTZWxlY3Rpb25Db250YWluZXIoYWN0dWFsRG9tQ2hpbGRyZW4sIHRoaXMuX2Zha2VTZWxlY3Rpb25Db250YWluZXIpOwogICAgICByZXR1cm4gZGlmZihhY3R1YWxEb21DaGlsZHJlbiwgZXhwZWN0ZWREb21DaGlsZHJlbiwgc2FtZU5vZGVzLmJpbmQobnVsbCwgdGhpcy5kb21Db252ZXJ0ZXIpKTsKICAgIH0KICAgIC8qKgogICAgICogRmluZHMgRE9NIG5vZGVzIHRoYXQgd2VyZSByZXBsYWNlZCB3aXRoIHRoZSBzaW1pbGFyIG5vZGVzIChzYW1lIHRhZyBuYW1lKSBpbiB0aGUgdmlldy4gQWxsIG5vZGVzIGFyZSBjb21wYXJlZAogICAgICogd2l0aGluIG9uZSBgaW5zZXJ0YC9gZGVsZXRlYCBhY3Rpb24gZ3JvdXAsIGZvciBleGFtcGxlOgogICAgICoKICAgICAqIAkJQWN0dWFsIERPTToJCTxwPjxiPkZvbzwvYj5CYXI8aT5CYXo8L2k+PGI+QmF4PC9iPjwvcD4KICAgICAqIAkJRXhwZWN0ZWQgRE9NOgk8cD5CYXI8Yj4xMjM8L2I+PGk+QmF6PC9pPjxiPjQ1NjwvYj48L3A+CiAgICAgKiAJCUlucHV0IGFjdGlvbnM6CVsgaW5zZXJ0LCBpbnNlcnQsIGRlbGV0ZSwgZGVsZXRlLCBlcXVhbCwgaW5zZXJ0LCBkZWxldGUgXQogICAgICogCQlPdXRwdXQgYWN0aW9uczoJWyBpbnNlcnQsIHJlcGxhY2UsIGRlbGV0ZSwgZXF1YWwsIHJlcGxhY2UgXQogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5LjxTdHJpbmc+fSBhY3Rpb25zIEFjdGlvbnMgYXJyYXkgd2hpY2ggaXMgYSByZXN1bHQgb2YgdGhlIHtAbGluayBtb2R1bGU6dXRpbHMvZGlmZn5kaWZmfSBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7QXJyYXkuPE5vZGU+fE5vZGVMaXN0fSBhY3R1YWxEb20gQWN0dWFsIERPTSBjaGlsZHJlbgogICAgICogQHBhcmFtIHtBcnJheS48Tm9kZT59IGV4cGVjdGVkRG9tIEV4cGVjdGVkIERPTSBjaGlsZHJlbi4KICAgICAqIEByZXR1cm5zIHtBcnJheS48U3RyaW5nPn0gQWN0aW9ucyBhcnJheSBtb2RpZmllZCB3aXRoIHRoZSBgcmVwbGFjZWAgYWN0aW9ucy4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfZmluZFJlcGxhY2VBY3Rpb25zIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZmluZFJlcGxhY2VBY3Rpb25zKGFjdGlvbnMsIGFjdHVhbERvbSwgZXhwZWN0ZWREb20pIHsKICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gYm90aCAnaW5zZXJ0JyBhbmQgJ2RlbGV0ZScgYWN0aW9ucywgbm8gbmVlZCB0byBjaGVjayBmb3IgcmVwbGFjZWQgZWxlbWVudHMuCiAgICAgIGlmIChhY3Rpb25zLmluZGV4T2YoJ2luc2VydCcpID09PSAtMSB8fCBhY3Rpb25zLmluZGV4T2YoJ2RlbGV0ZScpID09PSAtMSkgewogICAgICAgIHJldHVybiBhY3Rpb25zOwogICAgICB9CgogICAgICB2YXIgbmV3QWN0aW9ucyA9IFtdOwogICAgICB2YXIgYWN0dWFsU2xpY2UgPSBbXTsKICAgICAgdmFyIGV4cGVjdGVkU2xpY2UgPSBbXTsKICAgICAgdmFyIGNvdW50ZXIgPSB7CiAgICAgICAgZXF1YWw6IDAsCiAgICAgICAgaW5zZXJ0OiAwLAogICAgICAgIGRlbGV0ZTogMAogICAgICB9OwogICAgICB2YXIgX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjEyID0gdHJ1ZTsKICAgICAgdmFyIF9kaWRJdGVyYXRvckVycm9yMTIgPSBmYWxzZTsKICAgICAgdmFyIF9pdGVyYXRvckVycm9yMTIgPSB1bmRlZmluZWQ7CgogICAgICB0cnkgewogICAgICAgIGZvciAodmFyIF9pdGVyYXRvcjEyID0gYWN0aW9uc1tTeW1ib2wuaXRlcmF0b3JdKCksIF9zdGVwMTI7ICEoX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjEyID0gKF9zdGVwMTIgPSBfaXRlcmF0b3IxMi5uZXh0KCkpLmRvbmUpOyBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uMTIgPSB0cnVlKSB7CiAgICAgICAgICB2YXIgYWN0aW9uID0gX3N0ZXAxMi52YWx1ZTsKCiAgICAgICAgICBpZiAoYWN0aW9uID09PSAnaW5zZXJ0JykgewogICAgICAgICAgICBleHBlY3RlZFNsaWNlLnB1c2goZXhwZWN0ZWREb21bY291bnRlci5lcXVhbCArIGNvdW50ZXIuaW5zZXJ0XSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ2RlbGV0ZScpIHsKICAgICAgICAgICAgYWN0dWFsU2xpY2UucHVzaChhY3R1YWxEb21bY291bnRlci5lcXVhbCArIGNvdW50ZXIuZGVsZXRlXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBlcXVhbAogICAgICAgICAgICBuZXdBY3Rpb25zID0gbmV3QWN0aW9ucy5jb25jYXQoZGlmZihhY3R1YWxTbGljZSwgZXhwZWN0ZWRTbGljZSwgYXJlU2ltaWxhcikubWFwKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHggPT09ICdlcXVhbCcgPyAncmVwbGFjZScgOiB4OwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIG5ld0FjdGlvbnMucHVzaCgnZXF1YWwnKTsgLy8gUmVzZXQgc3RvcmVkIGVsZW1lbnRzIG9uICdlcXVhbCcuCgogICAgICAgICAgICBhY3R1YWxTbGljZSA9IFtdOwogICAgICAgICAgICBleHBlY3RlZFNsaWNlID0gW107CiAgICAgICAgICB9CgogICAgICAgICAgY291bnRlclthY3Rpb25dKys7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBfZGlkSXRlcmF0b3JFcnJvcjEyID0gdHJ1ZTsKICAgICAgICBfaXRlcmF0b3JFcnJvcjEyID0gZXJyOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoIV9pdGVyYXRvck5vcm1hbENvbXBsZXRpb24xMiAmJiBfaXRlcmF0b3IxMi5yZXR1cm4gIT0gbnVsbCkgewogICAgICAgICAgICBfaXRlcmF0b3IxMi5yZXR1cm4oKTsKICAgICAgICAgIH0KICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKF9kaWRJdGVyYXRvckVycm9yMTIpIHsKICAgICAgICAgICAgdGhyb3cgX2l0ZXJhdG9yRXJyb3IxMjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBuZXdBY3Rpb25zLmNvbmNhdChkaWZmKGFjdHVhbFNsaWNlLCBleHBlY3RlZFNsaWNlLCBhcmVTaW1pbGFyKS5tYXAoZnVuY3Rpb24gKHgpIHsKICAgICAgICByZXR1cm4geCA9PT0gJ2VxdWFsJyA/ICdyZXBsYWNlJyA6IHg7CiAgICAgIH0pKTsKICAgIH0KICAgIC8qKgogICAgICogTWFya3MgdGV4dCBub2RlcyB0byBiZSBzeW5jaHJvbml6ZWQuCiAgICAgKgogICAgICogSWYgYSB0ZXh0IG5vZGUgaXMgcGFzc2VkLCBpdCB3aWxsIGJlIG1hcmtlZC4gSWYgYW4gZWxlbWVudCBpcyBwYXNzZWQsIGFsbCBkZXNjZW5kYW50IHRleHQgbm9kZXMgaW5zaWRlIGl0IHdpbGwgYmUgbWFya2VkLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9ub2Rlfk5vZGV9IHZpZXdOb2RlIFZpZXcgbm9kZSB0byBzeW5jLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9tYXJrRGVzY2VuZGFudFRleHRUb1N5bmMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9tYXJrRGVzY2VuZGFudFRleHRUb1N5bmModmlld05vZGUpIHsKICAgICAgaWYgKCF2aWV3Tm9kZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHZpZXdOb2RlLmlzKCd0ZXh0JykpIHsKICAgICAgICB0aGlzLm1hcmtlZFRleHRzLmFkZCh2aWV3Tm9kZSk7CiAgICAgIH0gZWxzZSBpZiAodmlld05vZGUuaXMoJ2VsZW1lbnQnKSkgewogICAgICAgIHZhciBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uMTMgPSB0cnVlOwogICAgICAgIHZhciBfZGlkSXRlcmF0b3JFcnJvcjEzID0gZmFsc2U7CiAgICAgICAgdmFyIF9pdGVyYXRvckVycm9yMTMgPSB1bmRlZmluZWQ7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBmb3IgKHZhciBfaXRlcmF0b3IxMyA9IHZpZXdOb2RlLmdldENoaWxkcmVuKClbU3ltYm9sLml0ZXJhdG9yXSgpLCBfc3RlcDEzOyAhKF9pdGVyYXRvck5vcm1hbENvbXBsZXRpb24xMyA9IChfc3RlcDEzID0gX2l0ZXJhdG9yMTMubmV4dCgpKS5kb25lKTsgX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjEzID0gdHJ1ZSkgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBfc3RlcDEzLnZhbHVlOwoKICAgICAgICAgICAgdGhpcy5fbWFya0Rlc2NlbmRhbnRUZXh0VG9TeW5jKGNoaWxkKTsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIF9kaWRJdGVyYXRvckVycm9yMTMgPSB0cnVlOwogICAgICAgICAgX2l0ZXJhdG9yRXJyb3IxMyA9IGVycjsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKCFfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uMTMgJiYgX2l0ZXJhdG9yMTMucmV0dXJuICE9IG51bGwpIHsKICAgICAgICAgICAgICBfaXRlcmF0b3IxMy5yZXR1cm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgaWYgKF9kaWRJdGVyYXRvckVycm9yMTMpIHsKICAgICAgICAgICAgICB0aHJvdyBfaXRlcmF0b3JFcnJvcjEzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrcyBpZiB0aGUgc2VsZWN0aW9uIG5lZWRzIHRvIGJlIHVwZGF0ZWQgYW5kIHBvc3NpYmx5IHVwZGF0ZXMgaXQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlU2VsZWN0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlU2VsZWN0aW9uKCkgewogICAgICAvLyBJZiB0aGVyZSBpcyBubyBzZWxlY3Rpb24gLSByZW1vdmUgRE9NIGFuZCBmYWtlIHNlbGVjdGlvbnMuCiAgICAgIGlmICh0aGlzLnNlbGVjdGlvbi5yYW5nZUNvdW50ID09PSAwKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlRG9tU2VsZWN0aW9uKCk7CgogICAgICAgIHRoaXMuX3JlbW92ZUZha2VTZWxlY3Rpb24oKTsKCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgZG9tUm9vdCA9IHRoaXMuZG9tQ29udmVydGVyLm1hcFZpZXdUb0RvbSh0aGlzLnNlbGVjdGlvbi5lZGl0YWJsZUVsZW1lbnQpOyAvLyBEbyBub3RoaW5nIGlmIHRoZXJlIGlzIG5vIGZvY3VzLCBvciB0aGVyZSBpcyBubyBET00gZWxlbWVudCBjb3JyZXNwb25kaW5nIHRvIHNlbGVjdGlvbidzIGVkaXRhYmxlIGVsZW1lbnQuCgogICAgICBpZiAoIXRoaXMuaXNGb2N1c2VkIHx8ICFkb21Sb290KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIFJlbmRlciBzZWxlY3Rpb24uCgoKICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uLmlzRmFrZSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUZha2VTZWxlY3Rpb24oZG9tUm9vdCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlRmFrZVNlbGVjdGlvbigpOwoKICAgICAgICB0aGlzLl91cGRhdGVEb21TZWxlY3Rpb24oZG9tUm9vdCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlcyB0aGUgZmFrZSBzZWxlY3Rpb24uCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGRvbVJvb3QgQSB2YWxpZCBET00gcm9vdCB3aGVyZSB0aGUgZmFrZSBzZWxlY3Rpb24gY29udGFpbmVyIHNob3VsZCBiZSBhZGRlZC4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlRmFrZVNlbGVjdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZUZha2VTZWxlY3Rpb24oZG9tUm9vdCkgewogICAgICB2YXIgZG9tRG9jdW1lbnQgPSBkb21Sb290Lm93bmVyRG9jdW1lbnQ7CgogICAgICBpZiAoIXRoaXMuX2Zha2VTZWxlY3Rpb25Db250YWluZXIpIHsKICAgICAgICB0aGlzLl9mYWtlU2VsZWN0aW9uQ29udGFpbmVyID0gY3JlYXRlRmFrZVNlbGVjdGlvbkNvbnRhaW5lcihkb21Eb2N1bWVudCk7CiAgICAgIH0KCiAgICAgIHZhciBjb250YWluZXIgPSB0aGlzLl9mYWtlU2VsZWN0aW9uQ29udGFpbmVyOyAvLyBCaW5kIGZha2Ugc2VsZWN0aW9uIGNvbnRhaW5lciB3aXRoIHRoZSBjdXJyZW50IHNlbGVjdGlvbiAqcG9zaXRpb24qLgoKICAgICAgdGhpcy5kb21Db252ZXJ0ZXIuYmluZEZha2VTZWxlY3Rpb24oY29udGFpbmVyLCB0aGlzLnNlbGVjdGlvbik7CgogICAgICBpZiAoIXRoaXMuX2Zha2VTZWxlY3Rpb25OZWVkc1VwZGF0ZShkb21Sb290KSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCFjb250YWluZXIucGFyZW50RWxlbWVudCB8fCBjb250YWluZXIucGFyZW50RWxlbWVudCAhPSBkb21Sb290KSB7CiAgICAgICAgZG9tUm9vdC5hcHBlbmRDaGlsZChjb250YWluZXIpOwogICAgICB9CgogICAgICBjb250YWluZXIudGV4dENvbnRlbnQgPSB0aGlzLnNlbGVjdGlvbi5mYWtlU2VsZWN0aW9uTGFiZWwgfHwgIlx4QTAiOwogICAgICB2YXIgZG9tU2VsZWN0aW9uID0gZG9tRG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7CiAgICAgIHZhciBkb21SYW5nZSA9IGRvbURvY3VtZW50LmNyZWF0ZVJhbmdlKCk7CiAgICAgIGRvbVNlbGVjdGlvbi5yZW1vdmVBbGxSYW5nZXMoKTsKICAgICAgZG9tUmFuZ2Uuc2VsZWN0Tm9kZUNvbnRlbnRzKGNvbnRhaW5lcik7CiAgICAgIGRvbVNlbGVjdGlvbi5hZGRSYW5nZShkb21SYW5nZSk7CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZXMgdGhlIERPTSBzZWxlY3Rpb24uCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGRvbVJvb3QgQSB2YWxpZCBET00gcm9vdCB3aGVyZSB0aGUgRE9NIHNlbGVjdGlvbiBzaG91bGQgYmUgcmVuZGVyZWQuCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX3VwZGF0ZURvbVNlbGVjdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZURvbVNlbGVjdGlvbihkb21Sb290KSB7CiAgICAgIHZhciBkb21TZWxlY3Rpb24gPSBkb21Sb290Lm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0U2VsZWN0aW9uKCk7IC8vIExldCdzIGNoZWNrIHdoZXRoZXIgRE9NIHNlbGVjdGlvbiBuZWVkcyB1cGRhdGluZyBhdCBhbGwuCgogICAgICBpZiAoIXRoaXMuX2RvbVNlbGVjdGlvbk5lZWRzVXBkYXRlKGRvbVNlbGVjdGlvbikpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gTXVsdGktcmFuZ2Ugc2VsZWN0aW9uIGlzIG5vdCBhdmFpbGFibGUgaW4gbW9zdCBicm93c2VycywgYW5kLCBhdCBsZWFzdCBpbiBDaHJvbWUsIHRyeWluZyB0bwogICAgICAvLyBzZXQgc3VjaCBzZWxlY3Rpb24sIHRoYXQgaXMgbm90IGNvbnRpbnVvdXMsIHRocm93cyBhbiBlcnJvci4gQmVjYXVzZSBvZiB0aGF0LCB3ZSB3aWxsIGp1c3QgdXNlIGFuY2hvcgogICAgICAvLyBhbmQgZm9jdXMgb2YgdmlldyBzZWxlY3Rpb24uCiAgICAgIC8vIFNpbmNlIHdlIGFyZSBub3Qgc3VwcG9ydGluZyBtdWx0aS1yYW5nZSBzZWxlY3Rpb24sIHdlIGFsc28gZG8gbm90IG5lZWQgdG8gY2hlY2sgaWYgcHJvcGVyIGVkaXRhYmxlIGlzCiAgICAgIC8vIHNlbGVjdGVkLiBJZiB0aGVyZSBpcyBhbnkgZWRpdGFibGUgc2VsZWN0ZWQsIGl0IGlzIG9rYXkgKGVkaXRhYmxlIGlzIHRha2VuIGZyb20gc2VsZWN0aW9uIGFuY2hvcikuCgoKICAgICAgdmFyIGFuY2hvciA9IHRoaXMuZG9tQ29udmVydGVyLnZpZXdQb3NpdGlvblRvRG9tKHRoaXMuc2VsZWN0aW9uLmFuY2hvcik7CiAgICAgIHZhciBmb2N1cyA9IHRoaXMuZG9tQ29udmVydGVyLnZpZXdQb3NpdGlvblRvRG9tKHRoaXMuc2VsZWN0aW9uLmZvY3VzKTsgLy8gRm9jdXMgdGhlIG5ldyBlZGl0aW5nIGhvc3QuCiAgICAgIC8vIE90aGVyd2lzZSwgRkYgbWF5IHRocm93IGFuIGVycm9yIChodHRwczovL2dpdGh1Yi5jb20vY2tlZGl0b3IvY2tlZGl0b3I1L2lzc3Vlcy83MjEpLgoKICAgICAgZG9tUm9vdC5mb2N1cygpOwogICAgICBkb21TZWxlY3Rpb24uY29sbGFwc2UoYW5jaG9yLnBhcmVudCwgYW5jaG9yLm9mZnNldCk7CiAgICAgIGRvbVNlbGVjdGlvbi5leHRlbmQoZm9jdXMucGFyZW50LCBmb2N1cy5vZmZzZXQpOyAvLyBGaXJlZm944oCTc3BlY2lmaWMgaGFjayAoaHR0cHM6Ly9naXRodWIuY29tL2NrZWRpdG9yL2NrZWRpdG9yNS1lbmdpbmUvaXNzdWVzLzE0MzkpLgoKICAgICAgaWYgKGVudi5pc0dlY2tvKSB7CiAgICAgICAgZml4R2Vja29TZWxlY3Rpb25BZnRlckJyKGZvY3VzLCBkb21TZWxlY3Rpb24pOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrcyB3aGV0aGVyIGEgZ2l2ZW4gRE9NIHNlbGVjdGlvbiBuZWVkcyB0byBiZSB1cGRhdGVkLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge1NlbGVjdGlvbn0gZG9tU2VsZWN0aW9uIFRoZSBET00gc2VsZWN0aW9uIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge0Jvb2xlYW59CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX2RvbVNlbGVjdGlvbk5lZWRzVXBkYXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZG9tU2VsZWN0aW9uTmVlZHNVcGRhdGUoZG9tU2VsZWN0aW9uKSB7CiAgICAgIGlmICghdGhpcy5kb21Db252ZXJ0ZXIuaXNEb21TZWxlY3Rpb25Db3JyZWN0KGRvbVNlbGVjdGlvbikpIHsKICAgICAgICAvLyBDdXJyZW50IERPTSBzZWxlY3Rpb24gaXMgaW4gaW5jb3JyZWN0IHBvc2l0aW9uLiBXZSBuZWVkIHRvIHVwZGF0ZSBpdC4KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgdmFyIG9sZFZpZXdTZWxlY3Rpb24gPSBkb21TZWxlY3Rpb24gJiYgdGhpcy5kb21Db252ZXJ0ZXIuZG9tU2VsZWN0aW9uVG9WaWV3KGRvbVNlbGVjdGlvbik7CgogICAgICBpZiAob2xkVmlld1NlbGVjdGlvbiAmJiB0aGlzLnNlbGVjdGlvbi5pc0VxdWFsKG9sZFZpZXdTZWxlY3Rpb24pKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IC8vIElmIHNlbGVjdGlvbiBpcyBub3QgY29sbGFwc2VkLCBpdCBkb2VzIG5vdCBuZWVkIHRvIGJlIHVwZGF0ZWQgaWYgaXQgaXMgc2ltaWxhci4KCgogICAgICBpZiAoIXRoaXMuc2VsZWN0aW9uLmlzQ29sbGFwc2VkICYmIHRoaXMuc2VsZWN0aW9uLmlzU2ltaWxhcihvbGRWaWV3U2VsZWN0aW9uKSkgewogICAgICAgIC8vIFNlbGVjdGlvbiBkaWQgbm90IGNoYW5nZWQgYW5kIGlzIGNvcnJlY3QsIGRvIG5vdCB1cGRhdGUuCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IC8vIFNlbGVjdGlvbnMgYXJlIG5vdCBzaW1pbGFyLgoKCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3Mgd2hldGhlciB0aGUgZmFrZSBzZWxlY3Rpb24gbmVlZHMgdG8gYmUgdXBkYXRlZC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gZG9tUm9vdCBBIHZhbGlkIERPTSByb290IHdoZXJlIGEgbmV3IGZha2Ugc2VsZWN0aW9uIGNvbnRhaW5lciBzaG91bGQgYmUgYWRkZWQuCiAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfZmFrZVNlbGVjdGlvbk5lZWRzVXBkYXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZmFrZVNlbGVjdGlvbk5lZWRzVXBkYXRlKGRvbVJvb3QpIHsKICAgICAgdmFyIGNvbnRhaW5lciA9IHRoaXMuX2Zha2VTZWxlY3Rpb25Db250YWluZXI7CiAgICAgIHZhciBkb21TZWxlY3Rpb24gPSBkb21Sb290Lm93bmVyRG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7IC8vIEZha2Ugc2VsZWN0aW9uIG5lZWRzIHRvIGJlIHVwZGF0ZWQgaWYgdGhlcmUncyBubyBmYWtlIHNlbGVjdGlvbiBjb250YWluZXIsIG9yIHRoZSBjb250YWluZXIgY3VycmVudGx5IHNpdHMKICAgICAgLy8gaW4gYSBkaWZmZXJlbnQgcm9vdC4KCiAgICAgIGlmICghY29udGFpbmVyIHx8IGNvbnRhaW5lci5wYXJlbnRFbGVtZW50ICE9PSBkb21Sb290KSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gLy8gTWFrZSBzdXJlIHRoYXQgdGhlIHNlbGVjdGlvbiBhY3R1YWxseSBpcyB3aXRoaW4gdGhlIGZha2Ugc2VsZWN0aW9uLgoKCiAgICAgIGlmIChkb21TZWxlY3Rpb24uYW5jaG9yTm9kZSAhPT0gY29udGFpbmVyICYmICFjb250YWluZXIuY29udGFpbnMoZG9tU2VsZWN0aW9uLmFuY2hvck5vZGUpKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIHJldHVybiBjb250YWluZXIudGV4dENvbnRlbnQgIT09IHRoaXMuc2VsZWN0aW9uLmZha2VTZWxlY3Rpb25MYWJlbDsKICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlcyB0aGUgRE9NIHNlbGVjdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCgogIH0sIHsKICAgIGtleTogIl9yZW1vdmVEb21TZWxlY3Rpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9yZW1vdmVEb21TZWxlY3Rpb24oKSB7CiAgICAgIHZhciBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uMTQgPSB0cnVlOwogICAgICB2YXIgX2RpZEl0ZXJhdG9yRXJyb3IxNCA9IGZhbHNlOwogICAgICB2YXIgX2l0ZXJhdG9yRXJyb3IxNCA9IHVuZGVmaW5lZDsKCiAgICAgIHRyeSB7CiAgICAgICAgZm9yICh2YXIgX2l0ZXJhdG9yMTQgPSB0aGlzLmRvbURvY3VtZW50c1tTeW1ib2wuaXRlcmF0b3JdKCksIF9zdGVwMTQ7ICEoX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbjE0ID0gKF9zdGVwMTQgPSBfaXRlcmF0b3IxNC5uZXh0KCkpLmRvbmUpOyBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uMTQgPSB0cnVlKSB7CiAgICAgICAgICB2YXIgZG9jID0gX3N0ZXAxNC52YWx1ZTsKICAgICAgICAgIHZhciBkb21TZWxlY3Rpb24gPSBkb2MuZ2V0U2VsZWN0aW9uKCk7CgogICAgICAgICAgaWYgKGRvbVNlbGVjdGlvbi5yYW5nZUNvdW50KSB7CiAgICAgICAgICAgIHZhciBhY3RpdmVEb21FbGVtZW50ID0gZG9jLmFjdGl2ZUVsZW1lbnQ7CiAgICAgICAgICAgIHZhciB2aWV3RWxlbWVudCA9IHRoaXMuZG9tQ29udmVydGVyLm1hcERvbVRvVmlldyhhY3RpdmVEb21FbGVtZW50KTsKCiAgICAgICAgICAgIGlmIChhY3RpdmVEb21FbGVtZW50ICYmIHZpZXdFbGVtZW50KSB7CiAgICAgICAgICAgICAgZG9jLmdldFNlbGVjdGlvbigpLnJlbW92ZUFsbFJhbmdlcygpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBfZGlkSXRlcmF0b3JFcnJvcjE0ID0gdHJ1ZTsKICAgICAgICBfaXRlcmF0b3JFcnJvcjE0ID0gZXJyOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoIV9pdGVyYXRvck5vcm1hbENvbXBsZXRpb24xNCAmJiBfaXRlcmF0b3IxNC5yZXR1cm4gIT0gbnVsbCkgewogICAgICAgICAgICBfaXRlcmF0b3IxNC5yZXR1cm4oKTsKICAgICAgICAgIH0KICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKF9kaWRJdGVyYXRvckVycm9yMTQpIHsKICAgICAgICAgICAgdGhyb3cgX2l0ZXJhdG9yRXJyb3IxNDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlcyB0aGUgZmFrZSBzZWxlY3Rpb24uCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfcmVtb3ZlRmFrZVNlbGVjdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3JlbW92ZUZha2VTZWxlY3Rpb24oKSB7CiAgICAgIHZhciBjb250YWluZXIgPSB0aGlzLl9mYWtlU2VsZWN0aW9uQ29udGFpbmVyOwoKICAgICAgaWYgKGNvbnRhaW5lcikgewogICAgICAgIGNvbnRhaW5lci5yZW1vdmUoKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgZm9jdXMgbmVlZHMgdG8gYmUgdXBkYXRlZCBhbmQgcG9zc2libHkgdXBkYXRlcyBpdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCgogIH0sIHsKICAgIGtleTogIl91cGRhdGVGb2N1cyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZUZvY3VzKCkgewogICAgICBpZiAodGhpcy5pc0ZvY3VzZWQpIHsKICAgICAgICB2YXIgZWRpdGFibGUgPSB0aGlzLnNlbGVjdGlvbi5lZGl0YWJsZUVsZW1lbnQ7CgogICAgICAgIGlmIChlZGl0YWJsZSkgewogICAgICAgICAgdGhpcy5kb21Db252ZXJ0ZXIuZm9jdXMoZWRpdGFibGUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH1dKTsKCiAgcmV0dXJuIFJlbmRlcmVyOwp9KCk7CgpleHBvcnQgeyBSZW5kZXJlciBhcyBkZWZhdWx0IH07Cm1peChSZW5kZXJlciwgT2JzZXJ2YWJsZU1peGluKTsgLy8gQ2hlY2tzIGlmIHByb3ZpZGVkIGVsZW1lbnQgaXMgZWRpdGFibGUuCi8vCi8vIEBwcml2YXRlCi8vIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS92aWV3L2VsZW1lbnR+RWxlbWVudH0gZWxlbWVudAovLyBAcmV0dXJucyB7Qm9vbGVhbn0KCmZ1bmN0aW9uIGlzRWRpdGFibGUoZWxlbWVudCkgewogIGlmIChlbGVtZW50LmdldEF0dHJpYnV0ZSgnY29udGVudGVkaXRhYmxlJykgPT0gJ2ZhbHNlJykgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgdmFyIHBhcmVudCA9IGVsZW1lbnQuZmluZEFuY2VzdG9yKGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICByZXR1cm4gZWxlbWVudC5oYXNBdHRyaWJ1dGUoJ2NvbnRlbnRlZGl0YWJsZScpOwogIH0pOwogIHJldHVybiAhcGFyZW50IHx8IHBhcmVudC5nZXRBdHRyaWJ1dGUoJ2NvbnRlbnRlZGl0YWJsZScpID09ICd0cnVlJzsKfSAvLyBBZGRzIGlubGluZSBmaWxsZXIgYXQgYSBnaXZlbiBwb3NpdGlvbi4KLy8KLy8gVGhlIHBvc2l0aW9uIGNhbiBiZSBnaXZlbiBhcyBhbiBhcnJheSBvZiBET00gbm9kZXMgYW5kIGFuIG9mZnNldCBpbiB0aGF0IGFycmF5LAovLyBvciBhIERPTSBwYXJlbnQgZWxlbWVudCBhbmQgYW4gb2Zmc2V0IGluIHRoYXQgZWxlbWVudC4KLy8KLy8gQHByaXZhdGUKLy8gQHBhcmFtIHtEb2N1bWVudH0gZG9tRG9jdW1lbnQKLy8gQHBhcmFtIHtFbGVtZW50fEFycmF5LjxOb2RlPn0gZG9tUGFyZW50T3JBcnJheQovLyBAcGFyYW0ge051bWJlcn0gb2Zmc2V0Ci8vIEByZXR1cm5zIHtUZXh0fSBUaGUgRE9NIHRleHQgbm9kZSB0aGF0IGNvbnRhaW5zIGFuIGlubGluZSBmaWxsZXIuCgoKZnVuY3Rpb24gYWRkSW5saW5lRmlsbGVyKGRvbURvY3VtZW50LCBkb21QYXJlbnRPckFycmF5LCBvZmZzZXQpIHsKICB2YXIgY2hpbGROb2RlcyA9IGRvbVBhcmVudE9yQXJyYXkgaW5zdGFuY2VvZiBBcnJheSA/IGRvbVBhcmVudE9yQXJyYXkgOiBkb21QYXJlbnRPckFycmF5LmNoaWxkTm9kZXM7CiAgdmFyIG5vZGVBZnRlckZpbGxlciA9IGNoaWxkTm9kZXNbb2Zmc2V0XTsKCiAgaWYgKGlzVGV4dChub2RlQWZ0ZXJGaWxsZXIpKSB7CiAgICBub2RlQWZ0ZXJGaWxsZXIuZGF0YSA9IElOTElORV9GSUxMRVIgKyBub2RlQWZ0ZXJGaWxsZXIuZGF0YTsKICAgIHJldHVybiBub2RlQWZ0ZXJGaWxsZXI7CiAgfSBlbHNlIHsKICAgIHZhciBmaWxsZXJOb2RlID0gZG9tRG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoSU5MSU5FX0ZJTExFUik7CgogICAgaWYgKEFycmF5LmlzQXJyYXkoZG9tUGFyZW50T3JBcnJheSkpIHsKICAgICAgY2hpbGROb2Rlcy5zcGxpY2Uob2Zmc2V0LCAwLCBmaWxsZXJOb2RlKTsKICAgIH0gZWxzZSB7CiAgICAgIGluc2VydEF0KGRvbVBhcmVudE9yQXJyYXksIG9mZnNldCwgZmlsbGVyTm9kZSk7CiAgICB9CgogICAgcmV0dXJuIGZpbGxlck5vZGU7CiAgfQp9IC8vIFdoZXRoZXIgdHdvIERPTSBub2RlcyBzaG91bGQgYmUgY29uc2lkZXJlZCBhcyBzaW1pbGFyLgovLyBOb2RlcyBhcmUgY29uc2lkZXJlZCBzaW1pbGFyIGlmIHRoZXkgaGF2ZSB0aGUgc2FtZSB0YWcgbmFtZS4KLy8KLy8gQHByaXZhdGUKLy8gQHBhcmFtIHtOb2RlfSBub2RlMQovLyBAcGFyYW0ge05vZGV9IG5vZGUyCi8vIEByZXR1cm5zIHtCb29sZWFufQoKCmZ1bmN0aW9uIGFyZVNpbWlsYXIobm9kZTEsIG5vZGUyKSB7CiAgcmV0dXJuIGlzTm9kZShub2RlMSkgJiYgaXNOb2RlKG5vZGUyKSAmJiAhaXNUZXh0KG5vZGUxKSAmJiAhaXNUZXh0KG5vZGUyKSAmJiBub2RlMS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5vZGUyLnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKfSAvLyBXaGV0aGVyIHR3byBkb20gbm9kZXMgc2hvdWxkIGJlIGNvbnNpZGVyZWQgYXMgdGhlIHNhbWUuCi8vIFR3byBub2RlcyB3aGljaCBhcmUgY29uc2lkZXJlZCB0aGUgc2FtZSBhcmU6Ci8vCi8vCQkqIFRleHQgbm9kZXMgd2l0aCB0aGUgc2FtZSB0ZXh0LgovLwkJKiBFbGVtZW50IG5vZGVzIHJlcHJlc2VudGVkIGJ5IHRoZSBzYW1lIG9iamVjdC4KLy8JCSogVHdvIGJsb2NrIGZpbGxlciBlbGVtZW50cy4KLy8KLy8gQHByaXZhdGUKLy8gQHBhcmFtIHtTdHJpbmd9IGJsb2NrRmlsbGVyTW9kZSBCbG9jayBmaWxsZXIgbW9kZSwgc2VlIHtAbGluayBtb2R1bGU6ZW5naW5lL3ZpZXcvZG9tY29udmVydGVyfkRvbUNvbnZlcnRlciNibG9ja0ZpbGxlck1vZGV9LgovLyBAcGFyYW0ge05vZGV9IG5vZGUxCi8vIEBwYXJhbSB7Tm9kZX0gbm9kZTIKLy8gQHJldHVybnMge0Jvb2xlYW59CgoKZnVuY3Rpb24gc2FtZU5vZGVzKGRvbUNvbnZlcnRlciwgYWN0dWFsRG9tQ2hpbGQsIGV4cGVjdGVkRG9tQ2hpbGQpIHsKICAvLyBFbGVtZW50cy4KICBpZiAoYWN0dWFsRG9tQ2hpbGQgPT09IGV4cGVjdGVkRG9tQ2hpbGQpIHsKICAgIHJldHVybiB0cnVlOwogIH0gLy8gVGV4dHMuCiAgZWxzZSBpZiAoaXNUZXh0KGFjdHVhbERvbUNoaWxkKSAmJiBpc1RleHQoZXhwZWN0ZWREb21DaGlsZCkpIHsKICAgICAgcmV0dXJuIGFjdHVhbERvbUNoaWxkLmRhdGEgPT09IGV4cGVjdGVkRG9tQ2hpbGQuZGF0YTsKICAgIH0gLy8gQmxvY2sgZmlsbGVycy4KICAgIGVsc2UgaWYgKGRvbUNvbnZlcnRlci5pc0Jsb2NrRmlsbGVyKGFjdHVhbERvbUNoaWxkKSAmJiBkb21Db252ZXJ0ZXIuaXNCbG9ja0ZpbGxlcihleHBlY3RlZERvbUNoaWxkKSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IC8vIE5vdCBtYXRjaGluZyB0eXBlcy4KCgogIHJldHVybiBmYWxzZTsKfSAvLyBUaGUgZm9sbG93aW5nIGlzIGEgRmlyZWZveOKAk3NwZWNpZmljIGhhY2sgKGh0dHBzOi8vZ2l0aHViLmNvbS9ja2VkaXRvci9ja2VkaXRvcjUtZW5naW5lL2lzc3Vlcy8xNDM5KS4KLy8gV2hlbiB0aGUgbmF0aXZlIERPTSBzZWxlY3Rpb24gaXMgYXQgdGhlIGVuZCBvZiB0aGUgYmxvY2sgYW5kIHByZWNlZGVkIGJ5IDxiciAvPiBlLmcuCi8vCi8vCQk8cD5mb288YnIvPltdPC9wPgovLwovLyB3aGljaCBoYXBwZW5zIGEgbG90IHdoZW4gdXNpbmcgdGhlIHNvZnQgbGluZSBicmVhaywgdGhlIGJyb3dzZXIgZmFpbHMgdG8gKHZpc3VhbGx5KSBtb3ZlIHRoZQovLyBjYXJldCB0byB0aGUgbmV3IGxpbmUuIEEgcXVpY2sgZml4IGlzIGFzIHNpbXBsZSBhcyBmb3JjZeKAk3JlZnJlc2hpbmcgdGhlIHNlbGVjdGlvbiB3aXRoIHRoZSBzYW1lIHJhbmdlLgoKCmZ1bmN0aW9uIGZpeEdlY2tvU2VsZWN0aW9uQWZ0ZXJCcihmb2N1cywgZG9tU2VsZWN0aW9uKSB7CiAgdmFyIHBhcmVudCA9IGZvY3VzLnBhcmVudDsgLy8gVGhpcyBmaXggd29ya3Mgb25seSB3aGVuIHRoZSBmb2N1cyBwb2ludCBpcyBhdCB0aGUgdmVyeSBlbmQgb2YgYW4gZWxlbWVudC4KICAvLyBUaGVyZSBpcyBubyBwb2ludCBpbiBydW5uaW5nIGl0IGluIGNhc2VzIHVucmVsYXRlZCB0byB0aGUgYnJvd3NlciBidWcuCgogIGlmIChwYXJlbnQubm9kZVR5cGUgIT0gTm9kZS5FTEVNRU5UX05PREUgfHwgZm9jdXMub2Zmc2V0ICE9IHBhcmVudC5jaGlsZE5vZGVzLmxlbmd0aCAtIDEpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBjaGlsZEF0T2Zmc2V0ID0gcGFyZW50LmNoaWxkTm9kZXNbZm9jdXMub2Zmc2V0XTsgLy8gVG8gc3RheSBvbiB0aGUgc2FmZSBzaWRlLCB0aGUgZml4IGJlaW5nIGFzIHNwZWNpZmljIGFzIHBvc3NpYmxlLCBpdCB0YXJnZXRzIG9ubHkgdGhlCiAgLy8gc2VsZWN0aW9uIHdoaWNoIGlzIGF0IHRoZSB2ZXJ5IGVuZCBvZiB0aGUgZWxlbWVudCBhbmQgcHJlY2VkZWQgYnkgPGJyIC8+LgoKICBpZiAoY2hpbGRBdE9mZnNldCAmJiBjaGlsZEF0T2Zmc2V0LnRhZ05hbWUgPT0gJ0JSJykgewogICAgZG9tU2VsZWN0aW9uLmFkZFJhbmdlKGRvbVNlbGVjdGlvbi5nZXRSYW5nZUF0KDApKTsKICB9Cn0KCmZ1bmN0aW9uIGZpbHRlck91dEZha2VTZWxlY3Rpb25Db250YWluZXIoZG9tQ2hpbGRMaXN0LCBmYWtlU2VsZWN0aW9uQ29udGFpbmVyKSB7CiAgdmFyIGNoaWxkTGlzdCA9IEFycmF5LmZyb20oZG9tQ2hpbGRMaXN0KTsKCiAgaWYgKGNoaWxkTGlzdC5sZW5ndGggPT0gMCB8fCAhZmFrZVNlbGVjdGlvbkNvbnRhaW5lcikgewogICAgcmV0dXJuIGNoaWxkTGlzdDsKICB9CgogIHZhciBsYXN0ID0gY2hpbGRMaXN0W2NoaWxkTGlzdC5sZW5ndGggLSAxXTsKCiAgaWYgKGxhc3QgPT0gZmFrZVNlbGVjdGlvbkNvbnRhaW5lcikgewogICAgY2hpbGRMaXN0LnBvcCgpOwogIH0KCiAgcmV0dXJuIGNoaWxkTGlzdDsKfSAvLyBDcmVhdGVzIGEgZmFrZSBzZWxlY3Rpb24gY29udGFpbmVyIGZvciBhIGdpdmVuIGRvY3VtZW50LgovLwovLyBAcHJpdmF0ZQovLyBAcGFyYW0ge0RvY3VtZW50fSBkb21Eb2N1bWVudAovLyBAcmV0dXJucyB7SFRNTEVsZW1lbnR9CgoKZnVuY3Rpb24gY3JlYXRlRmFrZVNlbGVjdGlvbkNvbnRhaW5lcihkb21Eb2N1bWVudCkgewogIHZhciBjb250YWluZXIgPSBkb21Eb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICBPYmplY3QuYXNzaWduKGNvbnRhaW5lci5zdHlsZSwgewogICAgcG9zaXRpb246ICdmaXhlZCcsCiAgICB0b3A6IDAsCiAgICBsZWZ0OiAnLTk5OTlweCcsCiAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2NrZWRpdG9yL2NrZWRpdG9yNS9pc3N1ZXMvNzUyLgogICAgd2lkdGg6ICc0MnB4JwogIH0pOyAvLyBGaWxsIGl0IHdpdGggYSB0ZXh0IG5vZGUgc28gd2UgY2FuIHVwZGF0ZSBpdCBsYXRlci4KCiAgY29udGFpbmVyLnRleHRDb250ZW50ID0gIlx4QTAiOwogIHJldHVybiBjb250YWluZXI7Cn0="},{"version":3,"sources":["C:/Users/pc/Desktop/Restoran/Restoran/Restoran.UI/client/node_modules/@ckeditor/ckeditor5-engine/src/view/renderer.js"],"names":["ViewText","ViewPosition","INLINE_FILLER","INLINE_FILLER_LENGTH","startsWithFiller","isInlineFiller","mix","diff","insertAt","remove","ObservableMixin","CKEditorError","isText","isNode","fastDiff","env","Renderer","domConverter","selection","domDocuments","Set","markedAttributes","markedChildren","markedTexts","isFocused","_inlineFiller","_fakeSelectionContainer","type","node","mapViewToDom","parent","add","inlineFillerPosition","element","_updateChildrenMappings","_isSelectionInInlineFiller","_removeInlineFiller","_getInlineFillerPosition","_needsInlineFillerAtSelection","getFirstPosition","_updateAttrs","_updateChildren","has","_updateText","fillerDomPosition","viewPositionToDom","domDocument","ownerDocument","addInlineFiller","offset","_updateSelection","_updateFocus","clear","viewElement","domElement","actualDomChildren","childNodes","expectedDomChildren","Array","from","viewChildrenToDom","withChildren","_diffNodeLists","actions","_findReplaceActions","indexOf","counter","equal","insert","delete","action","insertIndex","deleteIndex","viewChild","getChild","is","_updateElementMappings","unbindDomElement","bindElements","firstPos","_createBefore","rangeCount","isCollapsed","selectionPosition","position","domFillerNode","parentNode","removeChild","data","substr","selectionParent","selectionOffset","root","isEditable","getFillerOffset","nodeBefore","nodeAfter","viewText","options","domText","findCorrespondingDomText","newDomText","viewToDom","actualText","expectedText","filler","index","insertData","values","join","deleteData","howMany","domAttrKeys","attributes","map","attr","name","viewAttrKeys","getAttributeKeys","key","setAttribute","getAttribute","hasAttribute","removeAttribute","bind","i","nodesToUnbind","_markDescendantTextToSync","domToView","filterOutFakeSelectionContainer","sameNodes","actualDom","expectedDom","newActions","actualSlice","expectedSlice","push","concat","areSimilar","x","viewNode","getChildren","child","_removeDomSelection","_removeFakeSelection","domRoot","editableElement","isFake","_updateFakeSelection","_updateDomSelection","createFakeSelectionContainer","container","bindFakeSelection","_fakeSelectionNeedsUpdate","parentElement","appendChild","textContent","fakeSelectionLabel","domSelection","getSelection","domRange","createRange","removeAllRanges","selectNodeContents","addRange","defaultView","_domSelectionNeedsUpdate","anchor","focus","collapse","extend","isGecko","fixGeckoSelectionAfterBr","isDomSelectionCorrect","oldViewSelection","domSelectionToView","isEqual","isSimilar","anchorNode","contains","doc","activeDomElement","activeElement","mapDomToView","editable","findAncestor","domParentOrArray","nodeAfterFiller","fillerNode","createTextNode","isArray","splice","node1","node2","tagName","toLowerCase","actualDomChild","expectedDomChild","isBlockFiller","nodeType","Node","ELEMENT_NODE","length","childAtOffset","getRangeAt","domChildList","fakeSelectionContainer","childList","last","pop","createElement","Object","assign","style","top","left","width"],"mappings":"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","sourcesContent":["/**\n * @license Copyright (c) 2003-2020, CKSource - Frederico Knabben. All rights reserved.\n * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license\n */\n\n/* globals Node */\n\n/**\n * @module engine/view/renderer\n */\n\nimport ViewText from './text';\nimport ViewPosition from './position';\nimport { INLINE_FILLER, INLINE_FILLER_LENGTH, startsWithFiller, isInlineFiller } from './filler';\n\nimport mix from '@ckeditor/ckeditor5-utils/src/mix';\nimport diff from '@ckeditor/ckeditor5-utils/src/diff';\nimport insertAt from '@ckeditor/ckeditor5-utils/src/dom/insertat';\nimport remove from '@ckeditor/ckeditor5-utils/src/dom/remove';\nimport ObservableMixin from '@ckeditor/ckeditor5-utils/src/observablemixin';\nimport CKEditorError from '@ckeditor/ckeditor5-utils/src/ckeditorerror';\nimport isText from '@ckeditor/ckeditor5-utils/src/dom/istext';\nimport isNode from '@ckeditor/ckeditor5-utils/src/dom/isnode';\nimport fastDiff from '@ckeditor/ckeditor5-utils/src/fastdiff';\nimport env from '@ckeditor/ckeditor5-utils/src/env';\n\n/**\n * Renderer is responsible for updating the DOM structure and the DOM selection based on\n * the {@link module:engine/view/renderer~Renderer#markToSync information about updated view nodes}.\n * In other words, it renders the view to the DOM.\n *\n * Its main responsibility is to make only the necessary, minimal changes to the DOM. However, unlike in many\n * virtual DOM implementations, the primary reason for doing minimal changes is not the performance but ensuring\n * that native editing features such as text composition, autocompletion, spell checking, selection's x-index are\n * affected as little as possible.\n *\n * Renderer uses {@link module:engine/view/domconverter~DomConverter} to transform view nodes and positions\n * to and from the DOM.\n */\nexport default class Renderer {\n\t/**\n\t * Creates a renderer instance.\n\t *\n\t * @param {module:engine/view/domconverter~DomConverter} domConverter Converter instance.\n\t * @param {module:engine/view/documentselection~DocumentSelection} selection View selection.\n\t */\n\tconstructor( domConverter, selection ) {\n\t\t/**\n\t\t * Set of DOM Documents instances.\n\t\t *\n\t\t * @readonly\n\t\t * @member {Set.<Document>}\n\t\t */\n\t\tthis.domDocuments = new Set();\n\n\t\t/**\n\t\t * Converter instance.\n\t\t *\n\t\t * @readonly\n\t\t * @member {module:engine/view/domconverter~DomConverter}\n\t\t */\n\t\tthis.domConverter = domConverter;\n\n\t\t/**\n\t\t * Set of nodes which attributes changed and may need to be rendered.\n\t\t *\n\t\t * @readonly\n\t\t * @member {Set.<module:engine/view/node~Node>}\n\t\t */\n\t\tthis.markedAttributes = new Set();\n\n\t\t/**\n\t\t * Set of elements which child lists changed and may need to be rendered.\n\t\t *\n\t\t * @readonly\n\t\t * @member {Set.<module:engine/view/node~Node>}\n\t\t */\n\t\tthis.markedChildren = new Set();\n\n\t\t/**\n\t\t * Set of text nodes which text data changed and may need to be rendered.\n\t\t *\n\t\t * @readonly\n\t\t * @member {Set.<module:engine/view/node~Node>}\n\t\t */\n\t\tthis.markedTexts = new Set();\n\n\t\t/**\n\t\t * View selection. Renderer updates DOM selection based on the view selection.\n\t\t *\n\t\t * @readonly\n\t\t * @member {module:engine/view/documentselection~DocumentSelection}\n\t\t */\n\t\tthis.selection = selection;\n\n\t\t/**\n\t\t * Indicates if the view document is focused and selection can be rendered. Selection will not be rendered if\n\t\t * this is set to `false`.\n\t\t *\n\t\t * @member {Boolean}\n\t\t */\n\t\tthis.isFocused = false;\n\n\t\t/**\n\t\t * The text node in which the inline filler was rendered.\n\t\t *\n\t\t * @private\n\t\t * @member {Text}\n\t\t */\n\t\tthis._inlineFiller = null;\n\n\t\t/**\n\t\t * DOM element containing fake selection.\n\t\t *\n\t\t * @private\n\t\t * @type {null|HTMLElement}\n\t\t */\n\t\tthis._fakeSelectionContainer = null;\n\t}\n\n\t/**\n\t * Marks a view node to be updated in the DOM by {@link #render `render()`}.\n\t *\n\t * Note that only view nodes whose parents have corresponding DOM elements need to be marked to be synchronized.\n\t *\n\t * @see #markedAttributes\n\t * @see #markedChildren\n\t * @see #markedTexts\n\t *\n\t * @param {module:engine/view/document~ChangeType} type Type of the change.\n\t * @param {module:engine/view/node~Node} node Node to be marked.\n\t */\n\tmarkToSync( type, node ) {\n\t\tif ( type === 'text' ) {\n\t\t\tif ( this.domConverter.mapViewToDom( node.parent ) ) {\n\t\t\t\tthis.markedTexts.add( node );\n\t\t\t}\n\t\t} else {\n\t\t\t// If the node has no DOM element it is not rendered yet,\n\t\t\t// its children/attributes do not need to be marked to be sync.\n\t\t\tif ( !this.domConverter.mapViewToDom( node ) ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( type === 'attributes' ) {\n\t\t\t\tthis.markedAttributes.add( node );\n\t\t\t} else if ( type === 'children' ) {\n\t\t\t\tthis.markedChildren.add( node );\n\t\t\t} else {\n\t\t\t\t/**\n\t\t\t\t * Unknown type passed to Renderer.markToSync.\n\t\t\t\t *\n\t\t\t\t * @error renderer-unknown-type\n\t\t\t\t */\n\t\t\t\tthrow new CKEditorError( 'view-renderer-unknown-type: Unknown type passed to Renderer.markToSync.', this );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Renders all buffered changes ({@link #markedAttributes}, {@link #markedChildren} and {@link #markedTexts}) and\n\t * the current view selection (if needed) to the DOM by applying a minimal set of changes to it.\n\t *\n\t * Renderer tries not to break the text composition (e.g. IME) and x-index of the selection,\n\t * so it does as little as it is needed to update the DOM.\n\t *\n\t * Renderer also handles {@link module:engine/view/filler fillers}. Especially, it checks if the inline filler is needed\n\t * at the selection position and adds or removes it. To prevent breaking text composition inline filler will not be\n\t * removed as long as the selection is in the text node which needed it at first.\n\t */\n\trender() {\n\t\tlet inlineFillerPosition;\n\n\t\t// Refresh mappings.\n\t\tfor ( const element of this.markedChildren ) {\n\t\t\tthis._updateChildrenMappings( element );\n\t\t}\n\n\t\t// There was inline filler rendered in the DOM but it's not\n\t\t// at the selection position any more, so we can remove it\n\t\t// (cause even if it's needed, it must be placed in another location).\n\t\tif ( this._inlineFiller && !this._isSelectionInInlineFiller() ) {\n\t\t\tthis._removeInlineFiller();\n\t\t}\n\n\t\t// If we've got the filler, let's try to guess its position in the view.\n\t\tif ( this._inlineFiller ) {\n\t\t\tinlineFillerPosition = this._getInlineFillerPosition();\n\t\t}\n\t\t// Otherwise, if it's needed, create it at the selection position.\n\t\telse if ( this._needsInlineFillerAtSelection() ) {\n\t\t\tinlineFillerPosition = this.selection.getFirstPosition();\n\n\t\t\t// Do not use `markToSync` so it will be added even if the parent is already added.\n\t\t\tthis.markedChildren.add( inlineFillerPosition.parent );\n\t\t}\n\n\t\tfor ( const element of this.markedAttributes ) {\n\t\t\tthis._updateAttrs( element );\n\t\t}\n\n\t\tfor ( const element of this.markedChildren ) {\n\t\t\tthis._updateChildren( element, { inlineFillerPosition } );\n\t\t}\n\n\t\tfor ( const node of this.markedTexts ) {\n\t\t\tif ( !this.markedChildren.has( node.parent ) && this.domConverter.mapViewToDom( node.parent ) ) {\n\t\t\t\tthis._updateText( node, { inlineFillerPosition } );\n\t\t\t}\n\t\t}\n\n\t\t// Check whether the inline filler is required and where it really is in the DOM.\n\t\t// At this point in most cases it will be in the DOM, but there are exceptions.\n\t\t// For example, if the inline filler was deep in the created DOM structure, it will not be created.\n\t\t// Similarly, if it was removed at the beginning of this function and then neither text nor children were updated,\n\t\t// it will not be present.\n\t\t// Fix those and similar scenarios.\n\t\tif ( inlineFillerPosition ) {\n\t\t\tconst fillerDomPosition = this.domConverter.viewPositionToDom( inlineFillerPosition );\n\t\t\tconst domDocument = fillerDomPosition.parent.ownerDocument;\n\n\t\t\tif ( !startsWithFiller( fillerDomPosition.parent ) ) {\n\t\t\t\t// Filler has not been created at filler position. Create it now.\n\t\t\t\tthis._inlineFiller = addInlineFiller( domDocument, fillerDomPosition.parent, fillerDomPosition.offset );\n\t\t\t} else {\n\t\t\t\t// Filler has been found, save it.\n\t\t\t\tthis._inlineFiller = fillerDomPosition.parent;\n\t\t\t}\n\t\t} else {\n\t\t\t// There is no filler needed.\n\t\t\tthis._inlineFiller = null;\n\t\t}\n\n\t\tthis._updateSelection();\n\t\tthis._updateFocus();\n\n\t\tthis.markedTexts.clear();\n\t\tthis.markedAttributes.clear();\n\t\tthis.markedChildren.clear();\n\t}\n\n\t/**\n\t * Updates mappings of view element's children.\n\t *\n\t * Children that were replaced in the view structure by similar elements (same tag name) are treated as 'replaced'.\n\t * This means that their mappings can be updated so the new view elements are mapped to the existing DOM elements.\n\t * Thanks to that these elements do not need to be re-rendered completely.\n\t *\n\t * @private\n\t * @param {module:engine/view/node~Node} viewElement The view element whose children mappings will be updated.\n\t */\n\t_updateChildrenMappings( viewElement ) {\n\t\tconst domElement = this.domConverter.mapViewToDom( viewElement );\n\n\t\tif ( !domElement ) {\n\t\t\t// If there is no `domElement` it means that it was already removed from DOM and there is no need to process it.\n\t\t\treturn;\n\t\t}\n\n\t\tconst actualDomChildren = this.domConverter.mapViewToDom( viewElement ).childNodes;\n\t\tconst expectedDomChildren = Array.from(\n\t\t\tthis.domConverter.viewChildrenToDom( viewElement, domElement.ownerDocument, { withChildren: false } )\n\t\t);\n\t\tconst diff = this._diffNodeLists( actualDomChildren, expectedDomChildren );\n\t\tconst actions = this._findReplaceActions( diff, actualDomChildren, expectedDomChildren );\n\n\t\tif ( actions.indexOf( 'replace' ) !== -1 ) {\n\t\t\tconst counter = { equal: 0, insert: 0, delete: 0 };\n\n\t\t\tfor ( const action of actions ) {\n\t\t\t\tif ( action === 'replace' ) {\n\t\t\t\t\tconst insertIndex = counter.equal + counter.insert;\n\t\t\t\t\tconst deleteIndex = counter.equal + counter.delete;\n\t\t\t\t\tconst viewChild = viewElement.getChild( insertIndex );\n\n\t\t\t\t\t// The 'uiElement' is a special one and its children are not stored in a view (#799),\n\t\t\t\t\t// so we cannot use it with replacing flow (since it uses view children during rendering\n\t\t\t\t\t// which will always result in rendering empty element).\n\t\t\t\t\tif ( viewChild && !viewChild.is( 'uiElement' ) ) {\n\t\t\t\t\t\tthis._updateElementMappings( viewChild, actualDomChildren[ deleteIndex ] );\n\t\t\t\t\t}\n\n\t\t\t\t\tremove( expectedDomChildren[ insertIndex ] );\n\t\t\t\t\tcounter.equal++;\n\t\t\t\t} else {\n\t\t\t\t\tcounter[ action ]++;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Updates mappings of a given view element.\n\t *\n\t * @private\n\t * @param {module:engine/view/node~Node} viewElement The view element whose mappings will be updated.\n\t * @param {Node} domElement The DOM element representing the given view element.\n\t */\n\t_updateElementMappings( viewElement, domElement ) {\n\t\t// Remap 'DomConverter' bindings.\n\t\tthis.domConverter.unbindDomElement( domElement );\n\t\tthis.domConverter.bindElements( domElement, viewElement );\n\n\t\t// View element may have children which needs to be updated, but are not marked, mark them to update.\n\t\tthis.markedChildren.add( viewElement );\n\n\t\t// Because we replace new view element mapping with the existing one, the corresponding DOM element\n\t\t// will not be rerendered. The new view element may have different attributes than the previous one.\n\t\t// Since its corresponding DOM element will not be rerendered, new attributes will not be added\n\t\t// to the DOM, so we need to mark it here to make sure its attributes gets updated. See #1427 for more\n\t\t// detailed case study.\n\t\t// Also there are cases where replaced element is removed from the view structure and then has\n\t\t// its attributes changed or removed. In such cases the element will not be present in `markedAttributes`\n\t\t// and also may be the same (`element.isSimilar()`) as the reused element not having its attributes updated.\n\t\t// To prevent such situations we always mark reused element to have its attributes rerenderd (#1560).\n\t\tthis.markedAttributes.add( viewElement );\n\t}\n\n\t/**\n\t * Gets the position of the inline filler based on the current selection.\n\t * Here, we assume that we know that the filler is needed and\n\t * {@link #_isSelectionInInlineFiller is at the selection position}, and, since it is needed,\n\t * it is somewhere at the selection position.\n\t *\n\t * Note: The filler position cannot be restored based on the filler's DOM text node, because\n\t * when this method is called (before rendering), the bindings will often be broken. View-to-DOM\n\t * bindings are only dependable after rendering.\n\t *\n\t * @private\n\t * @returns {module:engine/view/position~Position}\n\t */\n\t_getInlineFillerPosition() {\n\t\tconst firstPos = this.selection.getFirstPosition();\n\n\t\tif ( firstPos.parent.is( 'text' ) ) {\n\t\t\treturn ViewPosition._createBefore( this.selection.getFirstPosition().parent );\n\t\t} else {\n\t\t\treturn firstPos;\n\t\t}\n\t}\n\n\t/**\n\t * Returns `true` if the selection has not left the inline filler's text node.\n\t * If it is `true`, it means that the filler had been added for a reason and the selection did not\n\t * leave the filler's text node. For example, the user can be in the middle of a composition so it should not be touched.\n\t *\n\t * @private\n\t * @returns {Boolean} `true` if the inline filler and selection are in the same place.\n\t */\n\t_isSelectionInInlineFiller() {\n\t\tif ( this.selection.rangeCount != 1 || !this.selection.isCollapsed ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Note, we can't check if selection's position equals position of the\n\t\t// this._inlineFiller node, because of #663. We may not be able to calculate\n\t\t// the filler's position in the view at this stage.\n\t\t// Instead, we check it the other way – whether selection is anchored in\n\t\t// that text node or next to it.\n\n\t\t// Possible options are:\n\t\t// \"FILLER{}\"\n\t\t// \"FILLERadded-text{}\"\n\t\tconst selectionPosition = this.selection.getFirstPosition();\n\t\tconst position = this.domConverter.viewPositionToDom( selectionPosition );\n\n\t\tif ( position && isText( position.parent ) && startsWithFiller( position.parent ) ) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Removes the inline filler.\n\t *\n\t * @private\n\t */\n\t_removeInlineFiller() {\n\t\tconst domFillerNode = this._inlineFiller;\n\n\t\t// Something weird happened and the stored node doesn't contain the filler's text.\n\t\tif ( !startsWithFiller( domFillerNode ) ) {\n\t\t\t/**\n\t\t\t * The inline filler node was lost. Most likely, something overwrote the filler text node\n\t\t\t * in the DOM.\n\t\t\t *\n\t\t\t * @error view-renderer-filler-was-lost\n\t\t\t */\n\t\t\tthrow new CKEditorError( 'view-renderer-filler-was-lost: The inline filler node was lost.', this );\n\t\t}\n\n\t\tif ( isInlineFiller( domFillerNode ) ) {\n\t\t\tdomFillerNode.parentNode.removeChild( domFillerNode );\n\t\t} else {\n\t\t\tdomFillerNode.data = domFillerNode.data.substr( INLINE_FILLER_LENGTH );\n\t\t}\n\n\t\tthis._inlineFiller = null;\n\t}\n\n\t/**\n\t * Checks if the inline {@link module:engine/view/filler filler} should be added.\n\t *\n\t * @private\n\t * @returns {Boolean} `true` if the inline filler should be added.\n\t */\n\t_needsInlineFillerAtSelection() {\n\t\tif ( this.selection.rangeCount != 1 || !this.selection.isCollapsed ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst selectionPosition = this.selection.getFirstPosition();\n\t\tconst selectionParent = selectionPosition.parent;\n\t\tconst selectionOffset = selectionPosition.offset;\n\n\t\t// If there is no DOM root we do not care about fillers.\n\t\tif ( !this.domConverter.mapViewToDom( selectionParent.root ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif ( !( selectionParent.is( 'element' ) ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Prevent adding inline filler inside elements with contenteditable=false.\n\t\t// https://github.com/ckeditor/ckeditor5-engine/issues/1170\n\t\tif ( !isEditable( selectionParent ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// We have block filler, we do not need inline one.\n\t\tif ( selectionOffset === selectionParent.getFillerOffset() ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst nodeBefore = selectionPosition.nodeBefore;\n\t\tconst nodeAfter = selectionPosition.nodeAfter;\n\n\t\tif ( nodeBefore instanceof ViewText || nodeAfter instanceof ViewText ) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Checks if text needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t * @param {module:engine/view/text~Text} viewText View text to update.\n\t * @param {Object} options\n\t * @param {module:engine/view/position~Position} options.inlineFillerPosition The position where the inline\n\t * filler should be rendered.\n\t */\n\t_updateText( viewText, options ) {\n\t\tconst domText = this.domConverter.findCorrespondingDomText( viewText );\n\t\tconst newDomText = this.domConverter.viewToDom( viewText, domText.ownerDocument );\n\n\t\tconst actualText = domText.data;\n\t\tlet expectedText = newDomText.data;\n\n\t\tconst filler = options.inlineFillerPosition;\n\n\t\tif ( filler && filler.parent == viewText.parent && filler.offset == viewText.index ) {\n\t\t\texpectedText = INLINE_FILLER + expectedText;\n\t\t}\n\n\t\tif ( actualText != expectedText ) {\n\t\t\tconst actions = fastDiff( actualText, expectedText );\n\n\t\t\tfor ( const action of actions ) {\n\t\t\t\tif ( action.type === 'insert' ) {\n\t\t\t\t\tdomText.insertData( action.index, action.values.join( '' ) );\n\t\t\t\t} else { // 'delete'\n\t\t\t\t\tdomText.deleteData( action.index, action.howMany );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Checks if attribute list needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t * @param {module:engine/view/element~Element} viewElement The view element to update.\n\t */\n\t_updateAttrs( viewElement ) {\n\t\tconst domElement = this.domConverter.mapViewToDom( viewElement );\n\n\t\tif ( !domElement ) {\n\t\t\t// If there is no `domElement` it means that 'viewElement' is outdated as its mapping was updated\n\t\t\t// in 'this._updateChildrenMappings()'. There is no need to process it as new view element which\n\t\t\t// replaced old 'viewElement' mapping was also added to 'this.markedAttributes'\n\t\t\t// in 'this._updateChildrenMappings()' so it will be processed separately.\n\t\t\treturn;\n\t\t}\n\n\t\tconst domAttrKeys = Array.from( domElement.attributes ).map( attr => attr.name );\n\t\tconst viewAttrKeys = viewElement.getAttributeKeys();\n\n\t\t// Add or overwrite attributes.\n\t\tfor ( const key of viewAttrKeys ) {\n\t\t\tdomElement.setAttribute( key, viewElement.getAttribute( key ) );\n\t\t}\n\n\t\t// Remove from DOM attributes which do not exists in the view.\n\t\tfor ( const key of domAttrKeys ) {\n\t\t\tif ( !viewElement.hasAttribute( key ) ) {\n\t\t\t\tdomElement.removeAttribute( key );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Checks if elements child list needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t * @param {module:engine/view/element~Element} viewElement View element to update.\n\t * @param {Object} options\n\t * @param {module:engine/view/position~Position} options.inlineFillerPosition The position where the inline\n\t * filler should be rendered.\n\t */\n\t_updateChildren( viewElement, options ) {\n\t\tconst domElement = this.domConverter.mapViewToDom( viewElement );\n\n\t\tif ( !domElement ) {\n\t\t\t// If there is no `domElement` it means that it was already removed from DOM.\n\t\t\t// There is no need to process it. It will be processed when re-inserted.\n\t\t\treturn;\n\t\t}\n\n\t\tconst inlineFillerPosition = options.inlineFillerPosition;\n\t\tconst actualDomChildren = this.domConverter.mapViewToDom( viewElement ).childNodes;\n\t\tconst expectedDomChildren = Array.from(\n\t\t\tthis.domConverter.viewChildrenToDom( viewElement, domElement.ownerDocument, { bind: true, inlineFillerPosition } )\n\t\t);\n\n\t\t// Inline filler element has to be created as it is present in the DOM, but not in the view. It is required\n\t\t// during diffing so text nodes could be compared correctly and also during rendering to maintain\n\t\t// proper order and indexes while updating the DOM.\n\t\tif ( inlineFillerPosition && inlineFillerPosition.parent === viewElement ) {\n\t\t\taddInlineFiller( domElement.ownerDocument, expectedDomChildren, inlineFillerPosition.offset );\n\t\t}\n\n\t\tconst diff = this._diffNodeLists( actualDomChildren, expectedDomChildren );\n\n\t\tlet i = 0;\n\t\tconst nodesToUnbind = new Set();\n\n\t\t// Handle deletions first.\n\t\t// This is to prevent a situation where an element that already exists in `actualDomChildren` is inserted at a different\n\t\t// index in `actualDomChildren`. Since `actualDomChildren` is a `NodeList`, this works like move, not like an insert,\n\t\t// and it disrupts the whole algorithm. See https://github.com/ckeditor/ckeditor5/issues/6367.\n\t\t//\n\t\t// It doesn't matter in what order we remove or add nodes, as long as we remove and add correct nodes at correct indexes.\n\t\tfor ( const action of diff ) {\n\t\t\tif ( action === 'delete' ) {\n\t\t\t\tnodesToUnbind.add( actualDomChildren[ i ] );\n\t\t\t\tremove( actualDomChildren[ i ] );\n\t\t\t} else if ( action === 'equal' ) {\n\t\t\t\ti++;\n\t\t\t}\n\t\t}\n\n\t\ti = 0;\n\n\t\tfor ( const action of diff ) {\n\t\t\tif ( action === 'insert' ) {\n\t\t\t\tinsertAt( domElement, i, expectedDomChildren[ i ] );\n\t\t\t\ti++;\n\t\t\t} else if ( action === 'equal' ) {\n\t\t\t\t// Force updating text nodes inside elements which did not change and do not need to be re-rendered (#1125).\n\t\t\t\t// Do it here (not in the loop above) because only after insertions the `i` index is correct.\n\t\t\t\tthis._markDescendantTextToSync( this.domConverter.domToView( expectedDomChildren[ i ] ) );\n\t\t\t\ti++;\n\t\t\t}\n\t\t}\n\n\t\t// Unbind removed nodes. When node does not have a parent it means that it was removed from DOM tree during\n\t\t// comparision with the expected DOM. We don't need to check child nodes, because if child node was reinserted,\n\t\t// it was moved to DOM tree out of the removed node.\n\t\tfor ( const node of nodesToUnbind ) {\n\t\t\tif ( !node.parentNode ) {\n\t\t\t\tthis.domConverter.unbindDomElement( node );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Shorthand for diffing two arrays or node lists of DOM nodes.\n\t *\n\t * @private\n\t * @param {Array.<Node>|NodeList} actualDomChildren Actual DOM children\n\t * @param {Array.<Node>|NodeList} expectedDomChildren Expected DOM children.\n\t * @returns {Array.<String>} The list of actions based on the {@link module:utils/diff~diff} function.\n\t */\n\t_diffNodeLists( actualDomChildren, expectedDomChildren ) {\n\t\tactualDomChildren = filterOutFakeSelectionContainer( actualDomChildren, this._fakeSelectionContainer );\n\n\t\treturn diff( actualDomChildren, expectedDomChildren, sameNodes.bind( null, this.domConverter ) );\n\t}\n\n\t/**\n\t * Finds DOM nodes that were replaced with the similar nodes (same tag name) in the view. All nodes are compared\n\t * within one `insert`/`delete` action group, for example:\n\t *\n\t * \t\tActual DOM:\t\t<p><b>Foo</b>Bar<i>Baz</i><b>Bax</b></p>\n\t * \t\tExpected DOM:\t<p>Bar<b>123</b><i>Baz</i><b>456</b></p>\n\t * \t\tInput actions:\t[ insert, insert, delete, delete, equal, insert, delete ]\n\t * \t\tOutput actions:\t[ insert, replace, delete, equal, replace ]\n\t *\n\t * @private\n\t * @param {Array.<String>} actions Actions array which is a result of the {@link module:utils/diff~diff} function.\n\t * @param {Array.<Node>|NodeList} actualDom Actual DOM children\n\t * @param {Array.<Node>} expectedDom Expected DOM children.\n\t * @returns {Array.<String>} Actions array modified with the `replace` actions.\n\t */\n\t_findReplaceActions( actions, actualDom, expectedDom ) {\n\t\t// If there is no both 'insert' and 'delete' actions, no need to check for replaced elements.\n\t\tif ( actions.indexOf( 'insert' ) === -1 || actions.indexOf( 'delete' ) === -1 ) {\n\t\t\treturn actions;\n\t\t}\n\n\t\tlet newActions = [];\n\t\tlet actualSlice = [];\n\t\tlet expectedSlice = [];\n\n\t\tconst counter = { equal: 0, insert: 0, delete: 0 };\n\n\t\tfor ( const action of actions ) {\n\t\t\tif ( action === 'insert' ) {\n\t\t\t\texpectedSlice.push( expectedDom[ counter.equal + counter.insert ] );\n\t\t\t} else if ( action === 'delete' ) {\n\t\t\t\tactualSlice.push( actualDom[ counter.equal + counter.delete ] );\n\t\t\t} else { // equal\n\t\t\t\tnewActions = newActions.concat( diff( actualSlice, expectedSlice, areSimilar ).map( x => x === 'equal' ? 'replace' : x ) );\n\t\t\t\tnewActions.push( 'equal' );\n\t\t\t\t// Reset stored elements on 'equal'.\n\t\t\t\tactualSlice = [];\n\t\t\t\texpectedSlice = [];\n\t\t\t}\n\t\t\tcounter[ action ]++;\n\t\t}\n\n\t\treturn newActions.concat( diff( actualSlice, expectedSlice, areSimilar ).map( x => x === 'equal' ? 'replace' : x ) );\n\t}\n\n\t/**\n\t * Marks text nodes to be synchronized.\n\t *\n\t * If a text node is passed, it will be marked. If an element is passed, all descendant text nodes inside it will be marked.\n\t *\n\t * @private\n\t * @param {module:engine/view/node~Node} viewNode View node to sync.\n\t */\n\t_markDescendantTextToSync( viewNode ) {\n\t\tif ( !viewNode ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( viewNode.is( 'text' ) ) {\n\t\t\tthis.markedTexts.add( viewNode );\n\t\t} else if ( viewNode.is( 'element' ) ) {\n\t\t\tfor ( const child of viewNode.getChildren() ) {\n\t\t\t\tthis._markDescendantTextToSync( child );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Checks if the selection needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t */\n\t_updateSelection() {\n\t\t// If there is no selection - remove DOM and fake selections.\n\t\tif ( this.selection.rangeCount === 0 ) {\n\t\t\tthis._removeDomSelection();\n\t\t\tthis._removeFakeSelection();\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst domRoot = this.domConverter.mapViewToDom( this.selection.editableElement );\n\n\t\t// Do nothing if there is no focus, or there is no DOM element corresponding to selection's editable element.\n\t\tif ( !this.isFocused || !domRoot ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Render selection.\n\t\tif ( this.selection.isFake ) {\n\t\t\tthis._updateFakeSelection( domRoot );\n\t\t} else {\n\t\t\tthis._removeFakeSelection();\n\t\t\tthis._updateDomSelection( domRoot );\n\t\t}\n\t}\n\n\t/**\n\t * Updates the fake selection.\n\t *\n\t * @private\n\t * @param {HTMLElement} domRoot A valid DOM root where the fake selection container should be added.\n\t */\n\t_updateFakeSelection( domRoot ) {\n\t\tconst domDocument = domRoot.ownerDocument;\n\n\t\tif ( !this._fakeSelectionContainer ) {\n\t\t\tthis._fakeSelectionContainer = createFakeSelectionContainer( domDocument );\n\t\t}\n\n\t\tconst container = this._fakeSelectionContainer;\n\n\t\t// Bind fake selection container with the current selection *position*.\n\t\tthis.domConverter.bindFakeSelection( container, this.selection );\n\n\t\tif ( !this._fakeSelectionNeedsUpdate( domRoot ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( !container.parentElement || container.parentElement != domRoot ) {\n\t\t\tdomRoot.appendChild( container );\n\t\t}\n\n\t\tcontainer.textContent = this.selection.fakeSelectionLabel || '\\u00A0';\n\n\t\tconst domSelection = domDocument.getSelection();\n\t\tconst domRange = domDocument.createRange();\n\n\t\tdomSelection.removeAllRanges();\n\t\tdomRange.selectNodeContents( container );\n\t\tdomSelection.addRange( domRange );\n\t}\n\n\t/**\n\t * Updates the DOM selection.\n\t *\n\t * @private\n\t * @param {HTMLElement} domRoot A valid DOM root where the DOM selection should be rendered.\n\t */\n\t_updateDomSelection( domRoot ) {\n\t\tconst domSelection = domRoot.ownerDocument.defaultView.getSelection();\n\n\t\t// Let's check whether DOM selection needs updating at all.\n\t\tif ( !this._domSelectionNeedsUpdate( domSelection ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Multi-range selection is not available in most browsers, and, at least in Chrome, trying to\n\t\t// set such selection, that is not continuous, throws an error. Because of that, we will just use anchor\n\t\t// and focus of view selection.\n\t\t// Since we are not supporting multi-range selection, we also do not need to check if proper editable is\n\t\t// selected. If there is any editable selected, it is okay (editable is taken from selection anchor).\n\t\tconst anchor = this.domConverter.viewPositionToDom( this.selection.anchor );\n\t\tconst focus = this.domConverter.viewPositionToDom( this.selection.focus );\n\n\t\t// Focus the new editing host.\n\t\t// Otherwise, FF may throw an error (https://github.com/ckeditor/ckeditor5/issues/721).\n\t\tdomRoot.focus();\n\n\t\tdomSelection.collapse( anchor.parent, anchor.offset );\n\t\tdomSelection.extend( focus.parent, focus.offset );\n\n\t\t// Firefox–specific hack (https://github.com/ckeditor/ckeditor5-engine/issues/1439).\n\t\tif ( env.isGecko ) {\n\t\t\tfixGeckoSelectionAfterBr( focus, domSelection );\n\t\t}\n\t}\n\n\t/**\n\t * Checks whether a given DOM selection needs to be updated.\n\t *\n\t * @private\n\t * @param {Selection} domSelection The DOM selection to check.\n\t * @returns {Boolean}\n\t */\n\t_domSelectionNeedsUpdate( domSelection ) {\n\t\tif ( !this.domConverter.isDomSelectionCorrect( domSelection ) ) {\n\t\t\t// Current DOM selection is in incorrect position. We need to update it.\n\t\t\treturn true;\n\t\t}\n\n\t\tconst oldViewSelection = domSelection && this.domConverter.domSelectionToView( domSelection );\n\n\t\tif ( oldViewSelection && this.selection.isEqual( oldViewSelection ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// If selection is not collapsed, it does not need to be updated if it is similar.\n\t\tif ( !this.selection.isCollapsed && this.selection.isSimilar( oldViewSelection ) ) {\n\t\t\t// Selection did not changed and is correct, do not update.\n\t\t\treturn false;\n\t\t}\n\n\t\t// Selections are not similar.\n\t\treturn true;\n\t}\n\n\t/**\n\t * Checks whether the fake selection needs to be updated.\n\t *\n\t * @private\n\t * @param {HTMLElement} domRoot A valid DOM root where a new fake selection container should be added.\n\t * @returns {Boolean}\n\t */\n\t_fakeSelectionNeedsUpdate( domRoot ) {\n\t\tconst container = this._fakeSelectionContainer;\n\t\tconst domSelection = domRoot.ownerDocument.getSelection();\n\n\t\t// Fake selection needs to be updated if there's no fake selection container, or the container currently sits\n\t\t// in a different root.\n\t\tif ( !container || container.parentElement !== domRoot ) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// Make sure that the selection actually is within the fake selection.\n\t\tif ( domSelection.anchorNode !== container && !container.contains( domSelection.anchorNode ) ) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn container.textContent !== this.selection.fakeSelectionLabel;\n\t}\n\n\t/**\n\t * Removes the DOM selection.\n\t *\n\t * @private\n\t */\n\t_removeDomSelection() {\n\t\tfor ( const doc of this.domDocuments ) {\n\t\t\tconst domSelection = doc.getSelection();\n\n\t\t\tif ( domSelection.rangeCount ) {\n\t\t\t\tconst activeDomElement = doc.activeElement;\n\t\t\t\tconst viewElement = this.domConverter.mapDomToView( activeDomElement );\n\n\t\t\t\tif ( activeDomElement && viewElement ) {\n\t\t\t\t\tdoc.getSelection().removeAllRanges();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Removes the fake selection.\n\t *\n\t * @private\n\t */\n\t_removeFakeSelection() {\n\t\tconst container = this._fakeSelectionContainer;\n\n\t\tif ( container ) {\n\t\t\tcontainer.remove();\n\t\t}\n\t}\n\n\t/**\n\t * Checks if focus needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t */\n\t_updateFocus() {\n\t\tif ( this.isFocused ) {\n\t\t\tconst editable = this.selection.editableElement;\n\n\t\t\tif ( editable ) {\n\t\t\t\tthis.domConverter.focus( editable );\n\t\t\t}\n\t\t}\n\t}\n}\n\nmix( Renderer, ObservableMixin );\n\n// Checks if provided element is editable.\n//\n// @private\n// @param {module:engine/view/element~Element} element\n// @returns {Boolean}\nfunction isEditable( element ) {\n\tif ( element.getAttribute( 'contenteditable' ) == 'false' ) {\n\t\treturn false;\n\t}\n\n\tconst parent = element.findAncestor( element => element.hasAttribute( 'contenteditable' ) );\n\n\treturn !parent || parent.getAttribute( 'contenteditable' ) == 'true';\n}\n\n// Adds inline filler at a given position.\n//\n// The position can be given as an array of DOM nodes and an offset in that array,\n// or a DOM parent element and an offset in that element.\n//\n// @private\n// @param {Document} domDocument\n// @param {Element|Array.<Node>} domParentOrArray\n// @param {Number} offset\n// @returns {Text} The DOM text node that contains an inline filler.\nfunction addInlineFiller( domDocument, domParentOrArray, offset ) {\n\tconst childNodes = domParentOrArray instanceof Array ? domParentOrArray : domParentOrArray.childNodes;\n\tconst nodeAfterFiller = childNodes[ offset ];\n\n\tif ( isText( nodeAfterFiller ) ) {\n\t\tnodeAfterFiller.data = INLINE_FILLER + nodeAfterFiller.data;\n\n\t\treturn nodeAfterFiller;\n\t} else {\n\t\tconst fillerNode = domDocument.createTextNode( INLINE_FILLER );\n\n\t\tif ( Array.isArray( domParentOrArray ) ) {\n\t\t\tchildNodes.splice( offset, 0, fillerNode );\n\t\t} else {\n\t\t\tinsertAt( domParentOrArray, offset, fillerNode );\n\t\t}\n\n\t\treturn fillerNode;\n\t}\n}\n\n// Whether two DOM nodes should be considered as similar.\n// Nodes are considered similar if they have the same tag name.\n//\n// @private\n// @param {Node} node1\n// @param {Node} node2\n// @returns {Boolean}\nfunction areSimilar( node1, node2 ) {\n\treturn isNode( node1 ) && isNode( node2 ) &&\n\t\t!isText( node1 ) && !isText( node2 ) &&\n\t\tnode1.tagName.toLowerCase() === node2.tagName.toLowerCase();\n}\n\n// Whether two dom nodes should be considered as the same.\n// Two nodes which are considered the same are:\n//\n//\t\t* Text nodes with the same text.\n//\t\t* Element nodes represented by the same object.\n//\t\t* Two block filler elements.\n//\n// @private\n// @param {String} blockFillerMode Block filler mode, see {@link module:engine/view/domconverter~DomConverter#blockFillerMode}.\n// @param {Node} node1\n// @param {Node} node2\n// @returns {Boolean}\nfunction sameNodes( domConverter, actualDomChild, expectedDomChild ) {\n\t// Elements.\n\tif ( actualDomChild === expectedDomChild ) {\n\t\treturn true;\n\t}\n\t// Texts.\n\telse if ( isText( actualDomChild ) && isText( expectedDomChild ) ) {\n\t\treturn actualDomChild.data === expectedDomChild.data;\n\t}\n\t// Block fillers.\n\telse if ( domConverter.isBlockFiller( actualDomChild ) &&\n\t\tdomConverter.isBlockFiller( expectedDomChild ) ) {\n\t\treturn true;\n\t}\n\n\t// Not matching types.\n\treturn false;\n}\n\n// The following is a Firefox–specific hack (https://github.com/ckeditor/ckeditor5-engine/issues/1439).\n// When the native DOM selection is at the end of the block and preceded by <br /> e.g.\n//\n//\t\t<p>foo<br/>[]</p>\n//\n// which happens a lot when using the soft line break, the browser fails to (visually) move the\n// caret to the new line. A quick fix is as simple as force–refreshing the selection with the same range.\nfunction fixGeckoSelectionAfterBr( focus, domSelection ) {\n\tconst parent = focus.parent;\n\n\t// This fix works only when the focus point is at the very end of an element.\n\t// There is no point in running it in cases unrelated to the browser bug.\n\tif ( parent.nodeType != Node.ELEMENT_NODE || focus.offset != parent.childNodes.length - 1 ) {\n\t\treturn;\n\t}\n\n\tconst childAtOffset = parent.childNodes[ focus.offset ];\n\n\t// To stay on the safe side, the fix being as specific as possible, it targets only the\n\t// selection which is at the very end of the element and preceded by <br />.\n\tif ( childAtOffset && childAtOffset.tagName == 'BR' ) {\n\t\tdomSelection.addRange( domSelection.getRangeAt( 0 ) );\n\t}\n}\n\nfunction filterOutFakeSelectionContainer( domChildList, fakeSelectionContainer ) {\n\tconst childList = Array.from( domChildList );\n\n\tif ( childList.length == 0 || !fakeSelectionContainer ) {\n\t\treturn childList;\n\t}\n\n\tconst last = childList[ childList.length - 1 ];\n\n\tif ( last == fakeSelectionContainer ) {\n\t\tchildList.pop();\n\t}\n\n\treturn childList;\n}\n\n// Creates a fake selection container for a given document.\n//\n// @private\n// @param {Document} domDocument\n// @returns {HTMLElement}\nfunction createFakeSelectionContainer( domDocument ) {\n\tconst container = domDocument.createElement( 'div' );\n\n\tObject.assign( container.style, {\n\t\tposition: 'fixed',\n\t\ttop: 0,\n\t\tleft: '-9999px',\n\t\t// See https://github.com/ckeditor/ckeditor5/issues/752.\n\t\twidth: '42px'\n\t} );\n\n\t// Fill it with a text node so we can update it later.\n\tcontainer.textContent = '\\u00A0';\n\n\treturn container;\n}\n"]}]}